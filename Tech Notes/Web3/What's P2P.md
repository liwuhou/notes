P2P(Peer-to-peer) 是比特币的交易模式，是一种无需中介参与的交易方式。

交易的三要素为：防伪造、防篡改、防抵赖
在某个交易中，交易的双方都要对自己的操作进行数字签名(sign)，以确保操作是自己做的，不被他人伪造和篡改，自己也没法拘束。
保障做到这三点，就要了解了数字签名的概念。

### 数字签名
每个人都可以生成一个秘钥对，包含一个是公钥和一个私钥：私钥被称为 **Secret Key** 或者 **Private Key**，必须被严格保密，不能泄漏给其它人，而公钥则被称为 **Public Key**，可以公开给任何人。

- SK：Secret Key / Private Key （绝对保密）
- PK：Public Key （公开）

使用公钥加密的数据，只能用私钥解开。而使用私钥加密的数据，也能通过公钥来解密和验证。
当私钥持有人对某个消息签名的时候，他会使用自己的私钥对消息进行签名，然后把消息、签名以前自己的公钥发送出去。
其它的任何人都可以通过发消息人的公钥对这个签名进行验证。如果难通过，可以肯定这个消息没有经过篡改和伪造且是私钥持有人自愿发送的。
数字签名实现了交易中，防伪造、防篡改和防抵赖的三个作用。

### 数字签名算法
RSA算法，DSA算法和ECDSA算法。比特币采用的签名算法是椭圆曲线签名算法：ECDSA ，使用椭圆曲线是一个已经定义好的标准曲线 `secp256k1`：

$$ y^2 = x^3 + 7$$

![](http://cdn.liwuhou.cn/blog/202212112145302.png)

采用 ECDSA 签名算法需要一个私钥和公钥组成的秘钥对：私钥本质上就是一个1～2256的随机数，公钥是由私钥根据ECDSA算法推算出来的，通过私钥可以很容易推算出公钥，所以不必保存公钥，但是，通过公钥无法反推私钥，只能暴力破解。

比特币的私钥是一个随机的非常巨大的 256 位整数。它的上限，确切地说，比$2^{256}$要稍微小一点。比特币的公钥就是根据这个私钥推算出来的。
在比特币账本中，任何人都可以通过公开的公钥查询余额，但是，不知道这个公钥的主人是谁，这就是比特币的匿名性。
由于私钥是用户先行确定下来的 256 位整数，而一个私钥通过 ECDSA 算法会推导出来一个公钥，这个公钥就相当于用户在比特账本中的账号。

> 如果自己丢失了私钥，就永远无法花费对应公钥上的比特币了！

在现实世界中，如果自己忘记了银行卡密码，还可以拿着身份证去到银行柜台重新设置一个密码。但是在比特币的 P2P 网络中可不兴这一套，由于没有中央节点，大家的共识都依赖于数学上可证的各种算法。如果自己忘记了私钥，就再也不能花费公钥上的资产了。
而且也不能更改私钥，因为公钥是通过私钥推算出来的，更改私钥就相当于更改了公钥，就不是同一个账户了。

### 秘钥的安全性
私钥是一个 $2^{256}$ 位的随机数，这是一个非常大的数，它已经远远超过了整个银河系中原子的总数，真的可以算是一个天文数字了，想要单纯地靠猜测猜到别人的私钥，基本上是不可能的。

### 比特币钱包
比特币钱包实际上是用来帮助用户管理私钥的一类软件。
-  本地钱包：是把私钥保存在本地计算机硬盘上的钱包软件，如[Electrum](https://electrum.org/)；
-  手机钱包：和本地钱包类似，但可以直接在手机上运行，如[Bitpay](https://bitpay.com/)；
-  在线钱包：是把私钥委托给第三方在线服务商保存；
-  纸钱包：是指把私钥打印出来保存在纸上；
-  脑钱包：是指把私钥记在自己脑袋里

### 交易
每个区块链的区块中都至少记录了一笔交易，一笔交易就是把一定金额从一个比特币账户转移到另一个账户的记录。前面账号称为输入，后面账号称为输出。
比特币规定一个输出必须要把输入的金额全部花完，如果存在找零的情况，就把剩余的金额转给自己。这时就是一个输入对应多个输出

![](http://cdn.liwuhou.cn/blog/202212112212522.png)

而多个输入对应一个输出的情况就是输入的账户整合几笔交易最后输出给一个账户的情况。

![](http://cdn.liwuhou.cn/blog/202212112213054.png)

而在实际交易中，输入会比输出稍微大一点点，这个差额就是隐含的交易费用，也就是当前区块矿工的挖矿奖励。

![](http://cdn.liwuhou.cn/blog/202212112215134.png)

所以交易的费用就等于：

```
  交易费用 = 输入 - 输出 = (2.0 + 1.5) - (2.99 + 0.49) = 3.5 - 3.48 = 0.02
```

比特币的交易中，交易记录其实是由一系列的交易构成的。每一个交易都包含了一个或多个输入，以及一个或多个的输出。未花费的输出被称为 **UTXO**(Unspent Transcation Output )。

当我们要验证某个交易的时候，就要通过 **UTXO** 字段索引到前面已经发生过的交易，将输出的交易合并起来。
例如，对于交易`f36abd`，它记录的输入是`3f96ab`，索引号是`1`（索引号从`0`开始，`0`表示第一个输出，`1`表示第二个输出，以此类推），我们就根据`3f96ab`找到前面已发生的交易，再根据索引号找到对应的输出是0.5个比特币，所以，这笔交易的输入总计是0.5个比特币，输出分别是0.4个比特币和0.09个比特币，隐含的交易费用是0.01个比特币：

![](http://cdn.liwuhou.cn/blog/202212112220206.png)

### 小结

比特币使用数字签名保证零信任的可靠P2P交易：

-   私钥是花费比特币的唯一手段；
-   钱包软件是用来帮助用户管理私钥；
-   所有交易被记录在区块链中，可以通过公钥查询所有交易信息。