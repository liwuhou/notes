˙# 计算机网络概述

## 计算机网络的定义

计算机网络是 **互连** 的、**自治**的计算机的集合

1.  互连：利用通信链路连接相互独立的计算机系统
2.  自治：计算机系统彼此独立，不存在主从或者控制与被控制的关系

从技术范畴来看，计算机网络是**计算机技术**与**通信技术**相互融合的技术

ISP（Internet Service Provider) 因特网服务提供商

## 协议的定义

网络协议：网络通信实体之间在数据交换过程中需要遵循的规则或约定，例如：HTTP、FTP 等

网络协议的三要素：

1.  语法：定义实体之间交换信息的**格式与结构**
2.  语义：定义实体之间交换信息中的**控制信息**
3.  时序（同步）：定义实体之间交换信息的**顺序**以及如何匹配或适应彼此的**速度**

## 计算机网络的功能

1. 硬件资源共享：计算资源（CPU）、存储资源、打印机与扫描仪 I/O 等，例如云存储、云计算
2. 软件资源共享：软件共享的典型是SaaS（Software as a Service），软件及服务
3. 信息资源共享：信息检索、新闻浏览等

以上都属于资源，所以计算机网络最核心的功能即是资源共享

## 计算机网络的分类

总共的 4 种分类

### 按覆盖范围分类

1.  个域网（PAM)
2.  局域网（LAN）
3.  城域网（MaN）：覆盖一个城市
4.  广域网（WAN）： 覆盖

### 按拓扑结构分类

![拓扑结构](http://cdn.liwuhou.cn/tmp/20220103204244.png)

只考虑物体间的位置关系，而不考虑物体大小，用于表现网络中的主机、网络设备间的物理连接与布局。

1.  星形：有一个中央结点，网络中的主机通过点对点通信链路与中央结点连接，优点：易于监控管理、故障诊断、隔离，缺点：中央结点的压力较大，一旦故障，全网瘫痪，且网络规模受限于中央结点的端口数量。
2.  总线型：采用一条广播信道作为公共传输介质。所有结点均与总线连接，结点间的通信均通过共享的总线进行，优点：结构简单易于扩展，缺点：通信范围受限，容易受冲突
3.  环形：利用通信链路将所有结点连接成一个闭合的环，优点：电缆长度短，易于避免冲突，缺点：某结点故障易引起瘫痪，加新（撤出）结点比起麻烦
4.  网状：网络中的结点通过多条链路与不同的结点直接相连接（广域网、核心网络），优点：可靠性高（一条或多条链路故障时，网络仍然可以联通）所以适合用于核心网络。缺点：结构复杂，不利于维护。**可靠性最高**
5.  树形：可以看作是总线型拓扑和星形的扩展，优点易于扩展，故障易隔离，缺点：根结点压力较高
6.  混合：由两种以上的简单拓扑结构网络混合连接而成的网络，优点，易于扩展，可以构建不同规模的网络，缺点：结构复杂

### 按交换方式分类

1.  电路交换
2.  报文交换
3.  分组交换

### 按网络用户属性

1.  公用网：面向公众开放的网络，例如电信网络
2.  私有网：某个组织出资建设专门面向该组织，不对外开放



## 计算机网络结构

### 网络边缘

连接到网络上的主机或者端系统

### 接入网络

实现网络边缘的端系统与网络核心连接的网络，用于连接网络边缘和网络核心。

按覆盖范围划分：

1.  电话拨号接入：利用电话网络接入
2.  非对称数字用户线路 ADSL： 利用**电话网络**接入，基于频分多路利用技术，非对称，**独享式接入**
3.  混合光纤同轴电缆（HFC）接入网络：利用**有线电视网络**接入的技术，基于频分多路复用技术，非对称，**共享式接入**
4.  局域网：典型的局域网技术是**以太网**、**WIFI**等
5.  移动接入网络：利用移动通信网络，如 3G、4G、5G 网络

个人网（PAN）不属于覆盖范围

### 网络核心

由通信链路互连的分组交换设备构成的网络，作用是实现网络边缘中主机之间的数据的**中继与转发**

## 数据交换技术

交换设备：多通信商品，可以同时连接多个通信结点，进行通信的设备

数据交换：实现在大规模网络核心上进行数据传输的技术基础

数据交换的分类：电路交换、报文交换、分组交换

### 电路交换

以前的电话拨号，通过中间交换结点为两台主机之间建立了一条专用的通信线路，是最早出现的一种交换方法，电话网络是最早的也是最大的电路交换网络

电路交换的步骤：

1.  建立电路
2.  传输数据
3.  拆除电路

优点：实时性高、时延和时延抖动小

缺点：对于突发性数据传输，信道利用率低，传输速递单一

适用于语音和视频这类实时性要求比较高的业务

### 报文交换

报文： 发送方把要发送的信息附加上接收主机的地址和控制信息

报文交换： 发送方组装好报文，发给相邻报文交换机。相邻报文交换机收到报文后检查无误，暂时存储报文，然后找出需要转发的下一个结点的地址，然后把报文给下一个结点的报文交换机，即**存储—转发**的交换方式

优点：信道利用率高

缺点：时延长，有时还需要丢弃报文，分组交换即是改善这个缺点

### 分组交换

分组：将待传输的数据分割成较小的独立的数据块。每个数据块附加地址等构成数据分组。分组独立传输到目的地，到目的地再重组还原回数据

分组交换（**包交换**）：采用**存储—转发**的交换方式， **是计算机网络中使用最广泛的交换技术**

优点：

1.  交换设备存储容量要求低
2.  交换速度快
3.  可靠传输效率高
4.  更加公平

分组长度的确定：在其他条件相同的情况下，分组长度越长，延迟时间就越长。一般的分组长度：以**16B——4096B之间的 2^n B为标准的分组长度**

## 计算机网络性能

### 速率与带宽

速率：网络单位时间内传送的数据量，用以描述网络传输数据的快慢

速率基本单位：bit/s（位每秒/bps Bit Per Second）、Kbit/s（这里的 K 是 1000 的意思）、Mbit/s、Gbit/s、 Tbit/s

$1Kbit/s = 10^3bit/s$
$1Mbit/s = 10^6bit/s$
$1Gbit/s = 10^9bit/s$
$1Tbit/s = 10^12bit/s$


带宽：在通信和信号处理领域，指的是信号的频带宽度，单位：Hz（赫兹） 在计算机网络领域，指的是**一条信道的最高数据速率**，单位：bit/s（位每秒）

### 时延

通常将连接两个结点的直接链路称为一个“跳步”，简称跳

时延：**分组从网络中的一个结点到达另一结点所需的时间**

分组每跳传输过程中主要产生的 4 类时延：

1.  结点处理时延（`dc` —— delay cope）：交换设备检查分组是否有差错，确定如何转发分组的时间，**基本忽略不计**
2.  排队时延（`dq` —— delay queue up）：分组在交换结点内被交换到输出链路，等待从输出链路发送到下一个结点的时间
3.  传输时延/发送时延（`dt`）：分组在输出链路发送时，从发送第一位开始，到发送完最后一位需要的时间，$dt = L / R$ (L 分组长度bit，R 链路带宽bit/s）
4.  传播时延（`dp` —— propagation）：信号从发送端出来，经过一段物理链路到达接收端需要的时间，$dp = D / V$ (D物理链路长度 m，V 信号传播速度 m / s）

$dh = dc + dq + dt + dp$

### 时延带宽积

物理链路的传播时延 `（D / V）` 与链路带宽的乘积，记为 G

$$G = (传播时延s x 链路带宽 bit/s)bit$$
$$G=D/V∗RG = D / V * R G=D/V∗R$$

传播时延单位：`s`

带宽的单位： `bit/s`

时延带宽积的单位： `bit`

时延带宽积相当于，研究理想状态下，一条链路中可以容纳的最大数据位数

### 丢包率

**丢失分组和发送分组之比**，**反映网络的拥塞情况**

### 吞吐量

在单位时间内源主机通过网络向目的主机**实际送达的数据量**，记为 `Thr`，单位：`bit/s` 或 `B/s`

### 题型（精讲四）
![](http://cdn.liwuhou.cn/tmp/20220215161810.png)
![](https://secure2.wostatic.cn/static/x2raYBzSsQp7XTBUVmjunK/image.png)

## 计算机网络体系结构

**计算机网络所划分的层次以及各层协议的集合称为计算机网络体系结构**

值得注意的是，OSI 只获得了一些理论研究上的成果，在市场化方面却失败了，非国际标准的 TCP/IP 却获得了最广泛的应用，TCP/IP 常被称为事实上的国际标准

### 有关术语

- 数据单元：在层的实体之间传送的比特组
- 协议数据单元（Protocol Data Unit，PDU）：对等层之间传输的数据单元，不同的层中协议数据单元的名称各有不同
- 服务访问点：相邻层间的服务是通过其接口面上的服务访问点（Service Access Point, SAP）进行的，每个 SAP 有唯一的地址号码
- 服务原语：请求、指示、响应、证实

### OSI 参考模型

国际标准化组织：开放系统互连（Open System Interconnection, 简称OSI）参考模型

![OSI 参考模型](http://cdn.liwuhou.cn/tmp/20220215162031.png)

![](http://cdn.liwuhou.cn/tmp/20220215162051.png)
![](https://secure2.wostatic.cn/static/81rEQpjf9HsCTvHuPSQu7t/image.png)

-   应用层 —— 为用户提供网络服务。例如电子邮件，浏览器上网
-   表示层 —— 处理应用实体间交换数据的语法（格式与结构）
-   会话层 —— 用户与用户的连接
-   传输层 —— 提供端到端的逻辑通信服务
-   网络层 —— 数据的转发和路由选择
-   数据链路层 —— 相邻结点的数据传输
-   物理层 —— 在传输介质上实现比特流传输

速记口诀：“物链网输会使用”

**OSI 参考模型各对等层的协议数据单元的名称：**

-   应用层、表示层和会话层： **报文**
-   传输层：**数据段或报文段**
-   网络层：**分组或包**
-   数据链路层：**帧**
-   物理层：**比特流或位流**

1.  数据在垂直的层次中**自上而下**地逐层传递至物理层
2.  虚拟通信：对等层不直接进行通信
3.  实通信：物理层的两个端点进行物理通信
4.  第一个端到端层：传输层
5.  中间系统：通常只实现 **物理层、** **数据链路层** 和 **网络层** 功能

### TCP/IP 参考模型

实际最广泛应用的标准
![TCP/IP 参考模型](http://cdn.liwuhou.cn/tmp/20220215162242.png)

![OSI 参考模型与 TCP/IP 模型的对比](http://cdn.liwuhou.cn/tmp/20220215162332.png)


-   应用层
-   传输层
-   网络互联层/网际层 —— TCP/IP 参考模型核心 ⭐
-   网络接口层

_将 OSI 的应用层、表示层和会话层合并为应用层，数据链路层和物理层则合并为网络接口层_

**TCP/IP 参考模型各对等层的协议数据单元的名称：**

-   应用层：**报文**
-   传输层：**段**
-   网络互联层：**数据报**
-   网络接口层：**帧**

### 五层参考模型⭐

描述计算机网络中 **最常用、** **最接近实际网络**的参考模型
![五层参考模型](http://cdn.liwuhou.cn/tmp/20220215162652.png)

![五层参考模型的数据封装与解封装](http://cdn.liwuhou.cn/tmp/20220215162724.png)


-   应用层
-   传输层
-   网络层
-   链路层
-   物理层

TCP/IP 参考模型又太简单了，重新将 TCP/IP 参考模型的网络接口层拆分为数据链路层和物理层

**五层参考模型各对等层的协议数据单元的名称：**

-   应用层：**报文** ⭐
-   传输层：**段** ⭐
-   网络层：**数据报** ⭐
-   链路层：**帧** ⭐
-   物理层：**比特流** ⭐

## 计算机网络休与因特网发展简史

ARPAnet 是第一个分组交换的计算机网络，当今因特网的祖先

---

# 网络应用

> 五层参考模型中的应用层

## 计算机网络应用体系结构

### 客户/服务器（C/S)

**最典型、最基本**的网络应用

例如：www 应用、文件传输、电子邮件

特点：

1. 网络通信双方分为**客户程序**和**服务器程序**，用户与用户之间不进行直接通信
2. **服务器程序先运行**，做好接受通信的准备
3. **客户程序**后运行，**主动与服务器进行通信**

### 纯 P2P 结构网络应用

P2P（Peer to Peer）：通信双方没有传统意义上的客户端服务器之分，地位对等，通信双方都具备客户端与服务器的特征

### 混合结构网络应用

即 C/S 和 P2P 混合的网络应用

## 网络应用通信的基本原理

网络应用的基本通信过程：运行在不同主机上的**应用进程以 C/S 方式进行通信**

套接字（Socket）：典型的网络应用编程接口

端口号：标识套接字的编号

## 域名系统

### 域名系统DNS： Domain Naming System

域名解析：将 **域名** 映射为 **IP 地址**

域名解析的原理：为了实现域名解析，域名系统会建立 **分布式** 数据库，存储 **域名与 IP 地址的映射关系**数据

### 层次化域名空间

域名的命名方式：**层次树状结构命名**方式

每个域名由不同级别的域名构成，各个层级域名之间用点分隔，如：[www.baidu.com](http://www.baidu.com) (三级域名.二级域名.顶级域名）

顶级域名的分类：

1.  国家顶级域名：`cn`，`us`，`uk` 等
2.  通用顶级域名：`com`，`org`，`gov`，`edu` 等
3.  基本结构域名：只有一个（arpa，反向域名解析）

### 域名服务器⭐

DNS 服务器管辖的范围不以“域”为单位，而以“区”为单位

区：一个服务器所负责管辖的范围

根据其主要保存的域名信息以及在域名解析过程的作用，可以分为：

本地（默认）域名服务器

任何一个主机在配置网络地址时，都会配置一台域名服务器来作为默认域名服务器，在主机发起域名解析的时候最先请求的 dns 服务器

根域名服务器

**最重要的服务器**，全球有 13 组（个），保存所有**顶级域名服务器的域名**和 **IP 地址**

顶级域名服务器

负责管理所有在该顶级域名服务器注册的二级域名

权威域名服务器

负责保存管理该区中所有主机的域名和 ip 地址的映射

中间域名服务器

可能用不上，不是以上三种的域名服务器。

### 域名解析的过程⭐

1.  先查询本地的域名服务器中是否有域名信息，如果本地有则直接使用本地的映射关系，如果没有，根据根域名去查询根域名服务器
2.  根域名服务器通过根域名查询到对应**顶级域名服务器的 ip 地址**，根据二级域名去查询
3.  顶级域名服务器通过二级著名查询到下一个级别的域名服务器，跳往中间域名服务器或者权威域名服务器
4.  跳往其他中间域名服务器或权威域名服务器
5.  权威域名查询到该域名的 ip 地址的映射，查询结束

![域名解析的过程](http://cdn.liwuhou.cn/tmp/20220215163602.png)

递归解析：主机进行域名查询时，本地域名服务器同被查询域名的信息，则本地域名服务器 **代理主机** 查询根域名服务器。根域名服务器代理本地域名服务器查询下一个域名服务器，以此类推，直到得到被查询域名的 ip 地址，最后将解析结果返回个主机。（代替查询主机或其他域名服务器进行进一步的域名查询，并将最终解析结果发送给查询主机或服务器。）

![](http://cdn.liwuhou.cn/tmp/20220215163647.png)

迭代解析：主机进行域名查询时，本地服务器没有被查询域名信息，则先求助根域名服务器，根域名只是将下一步要查询的服务器告知查询主机的本地域名服务器，本地域名服务器继续查询下一个域名服务器，直到查询到被查询的域名的 ip 地址。（域名服务器不会代替查询主机或其他域名服务器进行进一步的域名查询， 只是将下一步要查询的服务器告知查询主机或服务器。）

![](http://cdn.liwuhou.cn/tmp/20220215163729.png)

## 万维网应用

### 万维网的应用结构

万维网应用包括：

-   **浏览器**： Web 应用 客户代理
-   **web 服务器：**存储用户请求浏览的 web 页面
-   **超文本传输协议（HyperText Transfer protocol ）HTTP**：客户端和服务端间交互基于的协议

统一资源定位符（Uniersal Resource Localtor, URL）：存放对象的 **主机域名**（或 IP 地址） + **对象的路径名** 例如`https://foo.com/bar.png`

### 超文本传输协议⭐

![](http://cdn.liwuhou.cn/tmp/20220215163854.png)

#### HTTP 概述

Web 应用的应用层协议，定义了浏览器如何向web 服务器发送请求，以及 web 服务器如何响应。

版本：HTTP/1.0 **HTTP/1.1** HTTP/2.0

#### HTTP 连接⭐

HTTP 基于传输层的 TCP（`Transmision Control Protocol`） 传输报文，浏览器在向服务器发送请求之前，首先建立 TCP 连接，然后才发送 HTTP 请求，接收 HTTP 响应。

**RTT**（Round Trip Time）：作为一个时间单位来使用，指HTTP 客户进程向服务器请求建立连接（从客户发送连接请求，到客户收到服务器连接确认，用时一个往返时间）

HTTP 使用 TCP 连接的两种策略：

-   非持久连接的 HTTP（**TCP 用一次就断开**，HTTP1.0常用）
    
    一次连接需要 2 个 RTT（非持久连接）一个 RTT 用来建立通路，一个 RTT 用来传输信息，**请求结束就断开连接了，下次请求又要重新建立**
    
    基于非持久连接的 HTTP 的特性，有一些改进方案：
    
    1.  并行连接：建立**多条并行的 TCP 连接**，并行发送 HTTP 请求和并行接收 HTTP 响应，然后断开 TCP 连接

持久连接的 HTTP（TCP 不断开）：

1.  非流水方式持久连接（非管道方式持久连接）：建立 TCP 连接，发送请求和接收响应后，**不断开** TCP 连接，继续请求
2.  流水方式持久连接：建立 TCP 连接后，**不断开 TCP 连接，继续并行请求**（HTTP1.1）

#### HTTP 报文

|          | 请求报文                        | 响应报文                               |
| -------- |:------------------------------- |:-------------------------------------- |
| 起始行   | 请求行：`<方法><URL><协议版本>` | 状态行：`<HTTP版本><状态码><原因短语>` |
| 首部行   | 携带附加信息                    | 携带附加信息                           |
| 空白行   | CRLF                            | CRLF                                   |
| 报文主体 | 实际要传输的内容                | 实际要传输的内容                       |

-   HTTP 报文起始行
    -   请求行
        -   方法：命令，表示客户端希望服务器对 URL 指定的资源执行的操作
        -   URL：定位所请求的资源
        -   协议版本：通告服务器客户端用的 HTTP 版本号
    -   状态行
        -   协议版本：通告服务器客户端用的 HTTP 版本号
        -   状态码：**通告客户端对请求的响应情况**，由 3 位十进制数组成
        -   短语：对状态码的进一步解释。相同状态码，不同短语，处理结果相同

| 请求方式 | 描述                                          |
|:-------- |:--------------------------------------------- |
| ** GET** | **请求读取由 URL 所标识的信息，最常见的方法** |
| HEAD     | 请求读取由 URL 所标识的信息的首部             |
| POST     | 给服务器添加信息                              |
| OPTION   | 请求一些选项的信息                            |
| PUT      | 在指明的 URL 下存储一个文档                   |


HTTP 状态码：3 位十进制数，利用第一位十进制数字区分 5 类状态码

| 状态码类 | 取值范围 | 作用           | 说明                                |
| -------- | -------- | -------------- | ----------------------------------- |
| 1xx      | 100-199  | 信息提示       | 通告信息，可能还需要进一步交互      |
| 2xx      | 200-299  | 成功           | 成功完成客户请求的操作，并进行响应  |
| 3xx      | 300-399  | 重定向         | 表示资源已移走，需要向新 URL 发请求 |
| 4xx      | 400-499  | **客户端**错误 | 由于客户端请求错误，无法成功响应    |
| 5xx      | 500-599  | **服务器**错误 | 由于服务器端错误，无法成功响应      |

| 状态码  | 短语                       | 含义                                     |
| ------- | -------------------------- |:---------------------------------------- |
| 100     | Continue                   | 已成功收到了请求的初始部分，请客户端继续 |
| 200     | Ok                         | 成功，所请求信息在响应报文中             |
| 301     | Moved Permanently          | 重定向                                   |
| 400     | Bad Request                | 客户端请求错误                           |
| 401     | Unauthorized               | 未授权，需要输入用户名和密码             |
| **404** | **Not Found**              | **客户端请求的对象，在服务器上不存在**   |
| 451     | Unsupported Media Type     | 不支持的媒体类型                         |
| 505     | HTTP Version Not Supported | 请求使用的 HTTP 版本，服务器不支持       |

### Cookies

HTTP 服务器不保存客户的数据，故被称为 **无状态协议**，而 Cookies 的机制就是用于用户跟踪

小型文本文件（Cookie）：网站为了辨别用户、进行会话跟踪而存储在 **用户本地终端** 上的数据

Cookies 技术主要包括 4 部分内容：

1.  HTTP 响应报文中的 Cookies 头行
2.  **用户浏览器** 在 **本地** 存储、维护和管理的 Cookies 文件
3.  HTTP 请求报文中的 Cookies 头行
4.  网站在后台数据库中存储、维护 Cookie 信息：分配给用户 ID、每个 ID 用户在本网站的访问特征等

## Internet 电子邮件

### 电子邮件系统结构

### 邮件服务器

电子邮件体系结构的核心

功能：

-   发送和接收邮件
-   向发信人报告邮件传送情况（已将会、被拒绝、丢失等）
-   用户注册
-   分配存储空间

#### 用户代理

电子邮件应用的客户端软件

-   Outlook
-   Apple Mail
-   Fox Mail等

支持用户撰写、显示、处理和收发邮件

为用户阅读、回复、转发、保存和撰写邮件提供编辑与操作环境

#### 简单邮件传输协议（SMTP）

SMTP（Simple Mail Transfer Protocol)：Internet 电子邮件中核心应用层协议。实现邮件服务器之间或用户代理到邮件服务器之间的 **邮件传输**

#### 邮件读取协议(POP3、IMAP、HTTP)

-   POP3（Post Office Protocol - Version 3): 第三版邮局协议
-   IMAP（Internet Message Access Protocol): 互联网邮件访问协议
-   HTTP（HyperText Transfer Protocol): Web 邮件系统的邮件读取协议

|        | IMAP                         | POP3                           |
|:------ | ---------------------------- | ------------------------------ |
| 相同点 | 邮件读取协议                 | 邮件读取协议                   |
| 不同点 | 对邮件的操作会反映在服务器上 | 对邮件的操作不会反映在服务器上 |

### SMTP简单邮件传输协议

SMTP 定义了**14 条命令**，每条命令用 4 个字母组成

-   HELO：标识发件人自己的身份
-   DATA：通知服务器准备开始发送邮件内容
-   QUIT：命令退出

SMTP 也定义了 **21 种应答信息**，一般只有一行，由 3 位数字的代码开始，后面附上（也可不附）简单的文字说明

SMTP 通过 **3 个阶段**的应用层交互完成邮件的传输

![](http://cdn.liwuhou.cn/tmp/20220118233828.png)

#### 握手阶段

SMTP 客户 C 和 SMTP 服务器 S 之间一封简单邮件传输的交互过程示例

```text
S: 220 mail.abc.com
C: HELO xyz.hit.edu.cn
S: 250 Hello xyz.hit.edu.cn,pleased to meet you
```

#### 邮件传输阶段

SMTP 客户 C 和 SMTP 服务器 S 之间一封简单邮件传输的交互过程示例

```text
C: MAIL FROM:<user_a@xyz.hit.edu.cn>
S: 250 user_a@xyz.hit.edu.cn ... Sender Ok
C: RCPT TO:<user_b@mail.abc.com>
S: 250 user_b@mail.abc.com ... Recipient Ok
C: DATA
S: 354 Enter mail,end with "." on a line by itself
C: =DATA=
C: ...
C: .
```

#### 邮件关闭阶段

SMTP客户 C 和 SMTP 服务器 S 之间一封简单邮件传输的交互过程示例

```text
S: 250 Message accepted for delivery
C: QUIT
S: 221 mail.abc.com closing connection
```

### SMTP 的特点：

-   SMTP 只能传送 7 位 ASCII 码文本内容，包括 SMTP 命令、应答消息及邮件内容
-   SMTP 传送的邮件内容中不能包含 `CRLF.CRLF` ，因为该信息用于标识邮件内容的结束
-   SMTP 是“**推动**”协议。（补充：HTTP 是“拉动”协议）
-   SMTP 使用 **TCP 连接是持久**的

传输非 7 位 ASCII 码 文本内容时，必须依据一个标准将非

### 电子邮件格式与 MIME

MIME：将非 ASCII 码文本内容转换为 ASCII 码文本内容的协议

#### 首部

| TO       | 后面收件人的电子邮件（*必填） |
|:-------- |:----------------------------- |
| Subject  | 邮件主题                      |
| Cc       | 表示应给发送一个邮件副件      |
| From     | 表示发件人的电子邮件地址      |
| Date     | 发信日期                      |
| Reply-To | 对方回信的日期                |

#### 空白

#### 行主体

互联网邮件扩展（Multipurpose Internet Mail Extensions,MIME）

传输非7位ASCII码文本内容时，必须依据一个标准将非7位ASCII码文本内容转换位7位ASCII码文本内容，然后再传输

### FTP

文件传送协议（File Transfer Protocol， FTP）： 在互联网的两个主机之间实现文件互传的网络应用的应用层协议

FTP 的应用结构：

-   主进程：负责接受新的客户请求
-   从属进程：负责处理单个客户请求，与具体的客户进行交互

控制信号：用户登录，服务器授权

数据连接：专门用于文件传输

带外控制：FTP 专门有一个独立的控制连接传输控制信息，与传输文件信息进行分离

FTP 是 **有状态**的协议

#### P2P

P2P（peer to peer）：通信双方没有传统意义上的客户服务器之分，地位对等，通信双方都具备客户和服务器的特征

例如：BitTorrent、PPlive 和 PPstream 等

应用特点：

1.  应用的对待方是用户的计算机
2.  很强的应用规模伸缩性
3.  应用在对等方之间进行
4.  应用充分聚集利用了端系统的计算能力以及网络传输宽带

### Socket 编程基础

**套接字**：典型的网络应用编程接口

**端口号**：标识套接字，一般由操作系统随机分配

| 端口号                 | 描述                        |
| ---------------------- | --------------------------- |
| 20（数据）、21（控制） | FTP 文件协议端口号          |
| 25                     | SMTP 简单邮件传输协议端口号 |
| 53                     | DNS域名服务器端口号         |
| 80                     | HTTP超文本传输协议端口号    |
| 110                    | POP3 第三版邮局协议端口号   |

套接字类型：

-   UDP 创建的套接字：数据报类型套接字（SOCK_DGRAM）
-   TCP 创建的套接字：流式套接字（SOCK_STREAM)
-   原始套接字SOCK_RAW

Socket Api 函数

1.  创建套接字：socket()
2.  绑定套接字的本地端点地址：bind()
3.  设置监听：listen()
4.  建立连接（TCP 独有）：
    -   TCP 客户端：connect()
    -   TCP 服务端：accept()
5.  接收数据：
    -   TCP: recv()
    -   UDP: recvfrom()
6.  发送数据：
    -   TCP: send()
    -   UDP: sendto()
7.  关闭套接字：close()

---

# 传输层

传输层的**核心任务：应用进程**之间提供**端到端**的**逻辑通信**服务

-   只有**主机才有传输层**
-   网络核心中间系统只用到下三层的功能（物理、链路、网络层）

## 传输层的基本服务

### 功能

> 分复流拥寻差错——可靠 吩咐刘墉寻差错——可靠

1.  对应用层的报文进行_分_段和重组
2.  面向应用层实现_复_用与分解（第二节）
3.  实现端到端的_流_量控制（第五节）
4.  _拥_塞控制（第五节）
5.  传输层_寻_址
6.  对报文进行_差错_检测
7.  实现进程间端到端_可靠_数据传输控制

### 传输层寻址与端口

传输层使用协议端口号，通常简称为端口

在全网范围内，利用 IP 地址+端口号 唯一标识一个通信端点

传输层端口号为 16 位整数，可以编号 65536 个($2^6$)

常用端口：端口号小于 256 的端口，见上节端口号表

|      0 ～ 1023 | 熟知端口号 | 服务器端口号 |
| --------------:| ---------- | ------------ |
|  1024 ～ 49151 | 登记端口号 | 服务器端口号 |
| 49151 ～ 65535 | 短暂端口号 | 客户端口号   |

### 无连接服务与面向连接服务

**无连接服务：**无需与端进行任何信息交换，直接构造传输层报文段并向接收端发送，类似于信件收发

**面向连接：**需要双方**交换一些控制信息**建立逻辑连接，然后再传输数据，传输结束后还需要拆除连接，类似于电话通信

## 传输层的复用与分解

### 多路复用和多路分解

支持众多应用进程共用同一个传输层协议，并能够将接收到的数据准确交付给 **不同的应用进程**

多路复用：在源主机，传输层协议从不同的套接字收集应用进程发送的数据块，并为每个数据块封闭上首部信息（包括用于分解的信息）构成的报文段，然后将报文段传递给网络层

多路分解：在目的主机，传输层协议读取报文段中的字段，标识出接收套接字，进而通过该套接字，将传输层的报文段中的数据交付给正确的套接字

### 无连接的多路复用和多路分解

用户数据报协议（User Datagram Protocol, UDP)：Internet 提供无连接服务的传输层协议

UDP 将应用层的数据块封装成一个 UDP 报文段

UDP 套接字二元组：<目的 IP 地址，目的端口号>

### 面向连接

传输控制协议（Transmission Control Protocol, TCP)：Internet 提供无连接服务的传输层协议

TCP 套接字四元组：<**源 IP 地址，源端口号**， 目的 IP 地址，目的端口号>

## 停-等协议与滑动窗口协议

不可靠传输信道在数据传输中可能发生：

1.  比特差错：1001 —— 1000
2.  乱序差错： 数据块 1、2、5、6、3、4
3.  数据丢失：数据块1、2、5

采取的措施：

1.  差错检测：利用编码实现数据包传输过程中的比特差错检测
2.  确认：接收方向发送方反馈接收状态。ACK（表示确认，Positive Acknoledgement），NAK（否定确认，Negative Acknowledgement）
3.  重传：发送方重新发送接收方没有正确接收的数据
4.  序号：确保数据按序提交
5.  计时器：**解决**（发现）数据丢失问题

### **停——等协议**：最简单的**自动重传协议**

差错检测、确认重传、序号、计时器 => 自动重传请求协议（Automatic Repeat reQuest, **ARQ**）

![](http://cdn.liwuhou.cn/tmp/20220215171620.png)

由于停-等协议性能差、信道利用率低，优化出来流水线协议（管道协议）：**允许发送方在没有确认前连续发送多个分组**。

最典型的流水线协议：**滑动窗口协议**

### 滑动窗口协议

1.  增加分组序号
2.  发送方和接收方可以缓存多个组合
3.  确认只采用 ACK，例如，正确接收分组 01，则返回 ACK01

发送窗口（$W_s$）：发送方可以发送未被确认分组的最大数量

接收窗口（$W_r$）：接收方可以缓存正确到达的分组的最大数量

滑动窗口协议，根据接收窗口的大小，可以具体分为：

#### GBN（Go-Back-N) 协议

$W_s$ ≥ 1 并且 $W_r$ = 1

累计确认

未按序到达的分组需要重传

![](http://cdn.liwuhou.cn/tmp/20220215171837.png)

SR（Selective Repeat） 协议

$W_s$ > 1 并且 $W_r$ > 1

逐个确认

发送方重传未被接收方确认的分组

![](http://cdn.liwuhou.cn/tmp/20220215171908.png)

![](http://cdn.liwuhou.cn/tmp/20220215171936.png)

## 用户数据报协议（UDP）

Internet **传输层**协议，提供**无连接、不可靠**、数据报尽力传输的服务

### UDP 特点

1.  应用进程容易控制发送什么数据以及何时发送，**会出现分组的丢失和重复**
2.  无需建立连接
3.  无连接状态
4.  首部开销小，只有 8 个字节（Byte）

### UDP 数据报结构

![](http://cdn.liwuhou.cn/tmp/20220215172013.png)

UDP 数据报首部：源端口号、目的端口号、长度和校验和（拢共 8 个字节）

UDP 数据报数据：应用数据

-   源端口号和目的端口号：UDP 实现复用和分解
-   长度：指示 UDP 报文段中的字节数（首部和数据的总和）
-   校验和：接收方使用来检测数据是否出现差错
-   应用数据：应用层数据占用

### UDP 校验和

接收方用来检测数据报是否出现差错（通过计算）

UDP 校验和计算规则（TCP 的校验和也是这么计算）

1.  所有参与运算的内容按 **16 **位对齐求和
2.  求和过程中遇到溢出（即进位）都被**回卷**（即进位与和的最低位再相加）
3.  最后得到的和**取反码**，就是 UDP 的校验和，填入到UDP 数据报的校验和字段

> UDP校验和计算的内容包括 3 部分：**UDP 伪首部**、**UDP 首部**、**应用数据**

UDP 伪首部长这样

![](http://cdn.liwuhou.cn/tmp/20220215172125.png)

-   源 IP 地址、目的地址、协议号：对应封装 UDP 数据报的 IP 分组的字段
-   UDP长度：该UDP数据报的字段，也就是说该字段会参与计算两次，不参与封装对应 UDP 数据报的 IP 分组对应字段
-   UDP 协议号：17

## 传输控制协议 （TCP）

Internet 传输层协议。提供**面向连接、可靠、有序**的字节流传输服务

1.  应用进程先建立连接
2.  每一条 TCP 连接**只有两个端点**
3.  可靠交付：无差错，不丢失，不重复，按序到达
4.  全双工通信

流：序列。应用程序和 TCP 的交互是一个个数据块，TCP 把他们看做是无结构字节流

### TCP 报文段结构

TCP 报文首部最多 60 个字节，**其中固定首部为 20 个字节，即最少 20 个字节**

![TCP 报文结构](http://cdn.liwuhou.cn/tmp/20220215172115.png)

1.  源端口号字段，目的端口号字段：占 16 位。复用和分解上层应用的数据
2.  序号字段：TCP 的序号是对每个应用层数据的**每个字节**进行编号⭐
3.  确认序号字段：**期望**从对方接收数据的字节序号，即该序号对应的字节尚未收到⭐
4.  首部长度字段：占 4 位，指出 TCP 段的首部长度，以 4 字节为计算单位，如首部长度字段值是 15，则这个 TCP 报文长度为 15∗4=6015 * 4 = 6015∗4=60，而固定首部恒为 20，则选项字段的_最大长度_也能算出来： 60−20=4060 - 20 = 4060−20=40
5.  首部保留字段：占 6 位，保留为今后使用，目前值为 0
6.  URG、ACK、PSH、RST、SYN、FIN 各占 1 位，为标志位字段，取值 0 或 1
    -   URG：Urgent——紧急，紧急指针有效时，优先传送
    -   ACK：Acknowledge——确认
    -   PSH：Push——推送，尽快将报文段中的数据交付接收应用进程，不要等缓存满了再交付
    -   RST：Rest——复位，TCP 连接出现严重差错，释放连接，再重新建立 TCP 连接
    -   SYN：Synchronous——同步，该 TCP 报文段是一个建立新连接请求控制段或者同意建立新连接的确认段
    -   FIN：Finish——终止，TCP 报文段的发送端数据已经发送完毕，请求释放连接
7.  接收窗口字段：占 16 位，向对方通告我方接收窗口大小。实现 TCP 流量控制
8.  校验和：占 16 位，计算方法同 UDP 检验和
9.  紧急指针：当 URG 标志位为 1 时，才有效，指出在本 TCP 报文段中紧急数据共有多少字节
10.  选项字段长度可变，最短 0 个字节，最长为 40 个字节
11.  填充字段：取值全为 0，目的是为了整个首部长度是 4 字节的整数倍

![](http://cdn.liwuhou.cn/tmp/20220215172149.png)

### TCP 连接管理

### TCP 连接的建立和拆除

TCP 连接的建立——三次握手

**第一次握手**：

客户端向服务器发送连接请求：（SYN=1,seq=x）

SYN = 1：建立连接请求控制段

seq = x：表示传输的报文段的第 1 个数据字节序列号是 x，此序列号代表整个报文段的序号

补充：（sequence number，序号的意思）

客户端进入 SYN_SEND（同步发送）状态

**第二次握手**：

服务器发回确认报文段：（SYN=1,ACK=1,seq=y,ack_seq=x+1）

SYN=1：同意建立新连接的确认段

ACK=1：确认序号字段有效

seq=y：服务器告诉客户确认报文段的序列号是 y

ack_seq=x+1：表示服务器已经收到序列号为 x 的报文段，准备接收序列号为x+1 的报文段

服务器由 LISTEN 进入 SYN_RCVD（同步收到）状态

**第三次握手**：

客户端对服务器的「同意连接报文段」进行确认：（ACK=1,seq=x+1,ack_seq=y+1）

ACK=1：确认序号字段有效

seq=x+1：客户此次的报文段的序列号是 x+1

ack_seq=y+1： 客户端下次期望接收到的服务器报文序列号为y+1

当客户发送 ACK 时，客户端进入 ESTABLISHED 状态——连接建立

当服务器收到 ACK 后，也进入 ESTABLISHED 状态

**第三次握手可以携带数据了**

A: 为什么一定是三次握手，不能多也不能少

Q: 三次握手就是**客户端跟服务器互相确认双方是否都具有正常收发数据的能力**，三次是最少的方式

1.  第一次握手：客户端发起连接请求，此时服务器知道客户端_发送功能正常_
2.  第二次握手：服务器发送确认，此时客户端知道服务端 _发送功能正常_和 _接收功能也正常_
3.  第三次握手：客户端发送确认，此时服务端知道客户端 接收_功能正常_

#### TCP 连接的拆除——四次挥手

**第一次挥手**：

客户端向服务器发送释放连接报文段：（FIN=1,seq=u）

FIN=1：发送端数据发送完毕，请求释放连接

seq=u：传输的第一个数据字节的序号是 u

客户端状态从 ESTABLISHED 进入 FIN_WAIT_1（终止等待1状态 ）

**第二次挥手**：

服务器向客户端发送确认段：（ACK=1,seq=v,ack_seq=u+1）

ACK=1：确认序号段有效

ack_seq=u+1：服务器期望接收客户数据序号为 u+1

seq=v：服务器传输的数据序号是 v

服务器状态由 ESTABLISHED 进入 CLOSE_WAIT（关闭等待）

客户端收到ACK字段后，由FIN_WAIT_1进入 FIN_WAIT_2 状态

**第三次挥手**：

服务器向客户端发送释放连接报文段（FIN=1,ACK=1,seq=v+1,ack_seq=u+1)

FIN=1：请求释放连接

ACK=1：确认序号段有效

seq=v+1：表示传输的第一个数据字节的序号是 v+1

ack_seq=u+1：表示服务器期望接收客户端数据序号为u+1+1

服务器由CLOSE_WAIT状态进入LACK_ACK（最后确认）

**第四次挥手**：

客户向服务器发送确认段：（ACK=1,seq=u+1,ack_seq=v+1+1)

ACK=1：确认序号字段有效

seq=u+1：表示客户端传输的数据的序号是 u+1

ack_seq=v+1+1：表示客户端期望接收服务器的数据序号是 v+1+1

客户端发送之后状态从 FIN_WAIT_2 进入 TIME_WAIT，等待 2MSL 时间，进入 CLOSED 状态

服务器在收到最后一次 ACK 后，由LAST_ACK进入 CLOSED 状态

### TCP 可靠传输

-   可靠：保证接收方应用进程从缓冲区读出的字节流与发送方发出的字节流是完全一样的
    
    保证实现可靠数据传输服务的工作机制：
    
    1.  应用层数据被分割成TCP认为最适合发送的数据块。
        
        最大报文段长度（Maxium Segment Size，MSS）：报文段中封装的应用数据的最大长度
        
    2.  序号，发送方对发送的数据包进行编号，确保数据按序提交给接收方。
        
        序号：一个字节占用一个序号。序号字段指的就是一个报文段第一个字节的序号
        
    3.  确认，接收方向发送方反馈接收状态，确认是否正确接收数据。
        
        确认：采用累积确认，例如：
        
        -   接收方正确接收了 123，此时返回确认序号 _4_
        -   接收方正确接收了 123 和 6，此时 4 和 5 也来了，此时返回确认序号为 _7_
    4.  查错检测，利用差错编码实现数据包传输过程中的比特查错检测（甚至纠正）。
        
    5.  重传，发送发重新发送接收方没有正确接收的数据。
      1. 发送方重新发送接收方没有正确接收的数据
      2. 针对两类事件：三次重复确认和计时器超时
        
    6.  计时器，在发送发引入计时器，**解决数据丢失问题**。

计时器超时的时间设置
    $$ TimeoutInterval = EstimatedRTT + 4 * DevRTT $$
 `EstimatedRTT` : 抽样 RTT 的加权移动平均值
 `DevRTT`: 偏差 RTT

 #### TCP生成 ACK 的策略
 1. 具有所期望序号的报文段按序到达，所有在期望序号及以前的报文段都已被确认。TCP 延迟 500ms 发送 ACK
 2. 具有所期望序号的报文段按序到达、且另一个按序报文段在等待 ACK 传输。TCP 接收方立即改善单个累计 ACK，确认以上两个按序到达报文段。
 3. 拥有序号大于期望序号的失序报文段到达
 4. 收到一个报文段部分或完全填充接收数据间隔

### 流量控制
协调发送方与接收方的数据发送与接收速度
在通信过程中， 接收方设置报文段的接收窗口字段来将窗口大小通知给发送方

### 拥塞控制
造成拥塞的原因：太多的主机以太快的速度向网络中发送了太多的数据，超出了网络处理能力，导致大量数据分组拥挤在蹭设备队列中等待转发，网络性能显著下降的现象

拥塞控制：通过合理调度、规范、调整向网络中发送数据的主机数量、发送速率、数据量，以避免拥塞或消除已发生的拥塞。

一些概念

拥塞窗口（CongWin）：连接开始时，CongWin = 1Mss（MSS: 1 个最大报文段长度（Maximum Segment Size)
阈值（Threshold）： 临界值
判断报文段丢失：是否经过三次重传？定时器是否超时？


TCP 拥塞控制的算法：
- 慢启动：在 TCP 连接建立时，窗口初始值为 1MESS，每经过一个 RTT 拥塞窗口就增大一倍，阈值为 16MESS
- 拥塞避免：当拥塞窗口大于或等于阈值时，第经过 1 个RTT，拥塞窗口的值加 1
- 快速重传：接收端收到 3 次重复确认，则推断被重复确认的报文段已经丢失，于是立即发送需要重传的报文段
- 快速恢复：当发生 3 次重复确认时，网络拥塞程度

> 快速重传和快速恢复解决的是 *三次重复确认和计时器超时* 的问题


![](http://cdn.liwuhou.cn/tmp/20220304082122.png)

# 网络层
 