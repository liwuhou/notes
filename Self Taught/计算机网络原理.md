# 计算机网络概述

## 计算机网络的定义

计算机网络是 **互连** 的、**自治**的计算机的集合

1.  互连：利用通信链路连接相互独立的计算机系统
2.  自治：计算机系统彼此独立，不存在主从或者控制与被控制的关系

从技术范畴来看，计算机网络是**计算机技术**与**通信技术**相互融合的技术

ISP（Internet Service Provider) 因特网服务提供商

## 协议的定义

网络协议：网络通信实体之间在数据交换过程中需要遵循的规则或约定，例如：HTTP、FTP 等

网络协议的三要素：

1.  语法：定义实体之间交换信息的**格式与结构**
2.  语义：定义实体之间交换信息中的**控制信息**
3.  时序（同步）：定义实体之间交换信息的**顺序**以及如何匹配或适应彼此的**速度**

## 计算机网络的功能

1. 硬件资源共享：计算资源（CPU）、存储资源、打印机与扫描仪 I/O 等，例如云存储、云计算
2. 软件资源共享：软件共享的典型是SaaS（Software as a Service），软件及服务
3. 信息资源共享：信息检索、新闻浏览等

以上都属于资源，所以计算机网络最核心的功能即是资源共享

## 计算机网络的分类

总共的 4 种分类

### 按覆盖范围分类

1.  个域网（PAM)
2.  局域网（LAN）
3.  城域网（MaN）：覆盖一个城市
4.  广域网（WAN）： 覆盖

### 按拓扑结构分类

![拓扑结构](http://cdn.liwuhou.cn/tmp/20220103204244.png)

只考虑物体间的位置关系，而不考虑物体大小，用于表现网络中的主机、网络设备间的物理连接与布局。

1.  星形：有一个中央结点，网络中的主机通过点对点通信链路与中央结点连接，优点：易于监控管理、故障诊断、隔离，缺点：中央结点的压力较大，一旦故障，全网瘫痪，且网络规模受限于中央结点的端口数量。
2.  总线型：采用一条广播信道作为公共传输介质。所有结点均与总线连接，结点间的通信均通过共享的总线进行，优点：结构简单易于扩展，缺点：通信范围受限，容易受冲突
3.  环形：利用通信链路将所有结点连接成一个闭合的环，优点：电缆长度短，易于避免冲突，缺点：某结点故障易引起瘫痪，加新（撤出）结点比起麻烦
4.  网状：网络中的结点通过多条链路与不同的结点直接相连接（广域网、核心网络），优点：可靠性高（一条或多条链路故障时，网络仍然可以联通）所以适合用于核心网络。缺点：结构复杂，不利于维护。**可靠性最高**
5.  树形：可以看作是总线型拓扑和星形的扩展，优点易于扩展，故障易隔离，缺点：根结点压力较高
6.  混合：由两种以上的简单拓扑结构网络混合连接而成的网络，优点，易于扩展，可以构建不同规模的网络，缺点：结构复杂

### 按交换方式分类

1.  电路交换
2.  报文交换
3.  分组交换

### 按网络用户属性

1.  公用网：面向公众开放的网络，例如电信网络
2.  私有网：某个组织出资建设专门面向该组织，不对外开放



## 计算机网络结构

### 网络边缘

连接到网络上的主机或者端系统

### 接入网络

实现网络边缘的端系统与网络核心连接的网络，用于连接网络边缘和网络核心。

按覆盖范围划分：

1.  电话拨号接入：利用电话网络接入
2.  非对称数字用户线路 ADSL： 利用**电话网络**接入，基于频分多路利用技术，非对称，**独享式接入**
3.  混合光纤同轴电缆（HFC）接入网络：利用**有线电视网络**接入的技术，基于频分多路复用技术，非对称，**共享式接入**
4.  局域网：典型的局域网技术是**以太网**、**WIFI**等
5.  移动接入网络：利用移动通信网络，如 3G、4G、5G 网络

个人网（PAN）不属于覆盖范围

### 网络核心

由通信链路互连的分组交换设备构成的网络，作用是实现网络边缘中主机之间的数据的**中继与转发**

## 数据交换技术

交换设备：多通信端口，可以同时连接多个通信结点，进行通信的设备

数据交换：实现在大规模网络核心上进行数据传输的技术基础

数据交换的分类：电路交换、报文交换、分组交换

### 电路交换

以前的电话拨号，通过中间交换结点为两台主机之间建立了一条专用的通信线路，是最早出现的一种交换方法，电话网络是最早的也是最大的电路交换网络

电路交换的步骤：

1.  建立电路
2.  传输数据
3.  拆除电路

优点：实时性高、时延和时延抖动小

缺点：对于突发性数据传输，信道利用率低，传输速递单一

适用于语音和视频这类实时性要求比较高的业务

### 报文交换

报文： 发送方把要发送的信息附加上接收主机的地址和控制信息

报文交换： 发送方组装好报文，发给相邻报文交换机。相邻报文交换机收到报文后检查无误，暂时存储报文，然后找出需要转发的下一个结点的地址，然后把报文给下一个结点的报文交换机，即**存储—转发**的交换方式

优点：信道利用率高

缺点：时延长，有时还需要丢弃报文，分组交换即是改善这个缺点

### 分组交换

分组：将待传输的数据分割成较小的独立的数据块。每个数据块附加地址等构成数据分组。分组独立传输到目的地，到目的地再重组还原回数据

分组交换（**包交换**）：采用**存储—转发**的交换方式， **是计算机网络中使用最广泛的交换技术**

优点：

1.  交换设备存储容量要求低
2.  交换速度快
3.  可靠传输效率高
4.  更加公平

分组长度的确定：在其他条件相同的情况下，分组长度越长，延迟时间就越长。一般的分组长度：以**16B——4096B之间的 2^n B为标准的分组长度**

## 计算机网络性能

### 速率与带宽

速率：网络单位时间内传送的数据量，用以描述网络传输数据的快慢

速率基本单位：bit/s（位每秒/bps Bit Per Second）、Kbit/s（这里的 K 是 1000 的意思）、Mbit/s、Gbit/s、 Tbit/s

$1Kbit/s = 10^3bit/s$
$1Mbit/s = 10^6bit/s$
$1Gbit/s = 10^9bit/s$
$1Tbit/s = 10^12bit/s$


带宽：在通信和信号处理领域，指的是信号的频带宽度，单位：Hz（赫兹） 在计算机网络领域，指的是**一条信道的最高数据速率**，单位：bit/s（位每秒）

### 时延

通常将连接两个结点的直接链路称为一个“跳步”，简称跳

时延：**分组从网络中的一个结点到达另一结点所需的时间**

分组每跳传输过程中主要产生的 4 类时延：

1.  结点处理时延（`dc` —— delay cope）：交换设备检查分组是否有差错，确定如何转发分组的时间，**基本忽略不计**
2.  排队时延（`dq` —— delay queue up）：分组在交换结点内被交换到输出链路，等待从输出链路发送到下一个结点的时间
3.  传输时延/发送时延（`dt`）：分组在输出链路发送时，从发送第一位开始，到发送完最后一位需要的时间，$dt = L / R$ (L 分组长度bit，R 链路带宽bit/s）
4.  传播时延（`dp` —— propagation）：信号从发送端出来，经过一段物理链路到达接收端需要的时间，$dp = D / V$ (D物理链路长度 m，V 信号传播速度 m / s）

$dh = dc + dq + dt + dp$

### 时延带宽积

物理链路的传播时延 `（D / V）` 与链路带宽的乘积，记为 G

$$G = (传播时延s \times 链路带宽 bit/s)bit$$
$$G=D/V∗RG = D / V * R G=D/V∗R$$

传播时延单位：`s`

带宽的单位： `bit/s`

时延带宽积的单位： `bit`

时延带宽积相当于，研究理想状态下，一条链路中可以容纳的最大数据位数

### 丢包率

**丢失分组和发送分组之比**，**反映网络的拥塞情况**

### 吞吐量

在单位时间内源主机通过网络向目的主机**实际送达的数据量**，记为 `Thr`，单位：`bit/s` 或 `B/s`

### 题型（精讲四）
![](http://cdn.liwuhou.cn/tmp/20220215161810.png)

![](https://secure2.wostatic.cn/static/x2raYBzSsQp7XTBUVmjunK/image.png)

## 计算机网络体系结构

**计算机网络所划分的层次以及各层协议的集合称为计算机网络体系结构**

值得注意的是，OSI 只获得了一些理论研究上的成果，在市场化方面却失败了，非国际标准的 TCP/IP 却获得了最广泛的应用，TCP/IP 常被称为事实上的国际标准

### 有关术语

- 数据单元：在层的实体之间传送的比特组
- 协议数据单元（Protocol Data Unit，PDU）：对等层之间传输的数据单元，不同的层中协议数据单元的名称各有不同
- 服务访问点：相邻层间的服务是通过其接口面上的服务访问点（Service Access Point, SAP）进行的，每个 SAP 有唯一的地址号码
- 服务原语：请求、指示、响应、证实

### OSI 参考模型

国际标准化组织：开放系统互连（Open System Interconnection, 简称OSI）参考模型

![OSI 参考模型](http://cdn.liwuhou.cn/tmp/20220215162031.png)

![](http://cdn.liwuhou.cn/tmp/20220215162051.png)
![](https://secure2.wostatic.cn/static/81rEQpjf9HsCTvHuPSQu7t/image.png)

-   应用层 —— 为用户提供网络服务。例如电子邮件，浏览器上网
-   表示层 —— 处理应用实体间交换数据的语法（格式与结构）
-   会话层 —— 用户与用户的连接
-   传输层 —— 提供端到端的逻辑通信服务
-   网络层 —— 数据的转发和路由选择
-   数据链路层 —— 相邻结点的数据传输
-   物理层 —— 在传输介质上实现比特流传输

速记口诀：“物链网输会使用”

**OSI 参考模型各对等层的协议数据单元的名称：**

-   应用层、表示层和会话层： **报文**
-   传输层：**数据段或报文段**
-   网络层：**分组或包**
-   数据链路层：**帧**
-   物理层：**比特流或位流**

1.  数据在垂直的层次中**自上而下**地逐层传递至物理层
2.  虚拟通信：对等层不直接进行通信
3.  实通信：物理层的两个端点进行物理通信
4.  第一个端到端层：传输层
5.  中间系统：通常只实现 **物理层、** **数据链路层** 和 **网络层** 功能

### TCP/IP 参考模型

实际最广泛应用的标准
![TCP/IP 参考模型](http://cdn.liwuhou.cn/tmp/20220215162242.png)

![OSI 参考模型与 TCP/IP 模型的对比](http://cdn.liwuhou.cn/tmp/20220215162332.png)


-   应用层
-   传输层
-   网络互联层/网际层 —— TCP/IP 参考模型核心 ⭐
-   网络接口层

_将 OSI 的应用层、表示层和会话层合并为应用层，数据链路层和物理层则合并为网络接口层_

**TCP/IP 参考模型各对等层的协议数据单元的名称：**

-   应用层：**报文**
-   传输层：**段**
-   网络互联层：**数据报**
-   网络接口层：**帧**

### 五层参考模型⭐

描述计算机网络中 **最常用、** **最接近实际网络**的参考模型
![五层参考模型](http://cdn.liwuhou.cn/tmp/20220215162652.png)

![五层参考模型的数据封装与解封装](http://cdn.liwuhou.cn/tmp/20220215162724.png)


-   应用层
-   传输层
-   网络层
-   链路层
-   物理层

TCP/IP 参考模型又太简单了，重新将 TCP/IP 参考模型的网络接口层拆分为数据链路层和物理层

**五层参考模型各对等层的协议数据单元的名称：**

-   应用层：**报文** ⭐
-   传输层：**段** ⭐
-   网络层：**数据报** ⭐
-   链路层：**帧** ⭐
-   物理层：**比特流** ⭐

## 计算机网络休与因特网发展简史

ARPAnet 是第一个分组交换的计算机网络，当今因特网的祖先

---

# 网络应用

> 五层参考模型中的应用层

## 计算机网络应用体系结构

### 客户/服务器（C/S)

**最典型、最基本**的网络应用

例如：www 应用、文件传输、电子邮件

特点：

1. 网络通信双方分为**客户程序**和**服务器程序**，用户与用户之间不进行直接通信
2. **服务器程序先运行**，做好接受通信的准备
3. **客户程序**后运行，**主动与服务器进行通信**

### 纯 P2P 结构网络应用

P2P（Peer to Peer）：通信双方没有传统意义上的客户端服务器之分，地位对等，通信双方都具备客户端与服务器的特征

### 混合结构网络应用

即 C/S 和 P2P 混合的网络应用

## 网络应用通信的基本原理

网络应用的基本通信过程：运行在不同主机上的**应用进程以 C/S 方式进行通信**

套接字（Socket）：典型的网络应用编程接口

端口号：标识套接字的编号

## 域名系统

### 域名系统DNS： Domain Naming System

域名解析：将 **域名** 映射为 **IP 地址**

域名解析的原理：为了实现域名解析，域名系统会建立 **分布式** 数据库，存储 **域名与 IP 地址的映射关系**数据

### 层次化域名空间

域名的命名方式：**层次树状结构命名**方式

每个域名由不同级别的域名构成，各个层级域名之间用点分隔，如：[www.baidu.com](http://www.baidu.com) (三级域名.二级域名.顶级域名）

顶级域名的分类：

1.  国家顶级域名：`cn`，`us`，`uk` 等
2.  通用顶级域名：`com`，`org`，`gov`，`edu` 等
3.  基本结构域名：只有一个（arpa，反向域名解析）

### 域名服务器⭐

DNS 服务器管辖的范围不以“域”为单位，而以“区”为单位

区：一个服务器所负责管辖的范围

根据其主要保存的域名信息以及在域名解析过程的作用，可以分为：

本地（默认）域名服务器

任何一个主机在配置网络地址时，都会配置一台域名服务器来作为默认域名服务器，在主机发起域名解析的时候最先请求的 dns 服务器

根域名服务器

**最重要的服务器**，全球有 13 组（个），保存所有**顶级域名服务器的域名**和 **IP 地址**

顶级域名服务器

负责管理所有在该顶级域名服务器注册的二级域名

权威域名服务器

负责保存管理该区中所有主机的域名和 ip 地址的映射

中间域名服务器

可能用不上，不是以上三种的域名服务器。

### 域名解析的过程⭐

1.  先查询本地的域名服务器中是否有域名信息，如果本地有则直接使用本地的映射关系，如果没有，根据根域名去查询根域名服务器
2.  根域名服务器通过根域名查询到对应**顶级域名服务器的 ip 地址**，根据二级域名去查询
3.  顶级域名服务器通过二级著名查询到下一个级别的域名服务器，跳往中间域名服务器或者权威域名服务器
4.  跳往其他中间域名服务器或权威域名服务器
5.  权威域名查询到该域名的 ip 地址的映射，查询结束

![域名解析的过程](http://cdn.liwuhou.cn/tmp/20220215163602.png)

递归解析：主机进行域名查询时，本地域名服务器同被查询域名的信息，则本地域名服务器 **代理主机** 查询根域名服务器。根域名服务器代理本地域名服务器查询下一个域名服务器，以此类推，直到得到被查询域名的 ip 地址，最后将解析结果返回个主机。（代替查询主机或其他域名服务器进行进一步的域名查询，并将最终解析结果发送给查询主机或服务器。）

![](http://cdn.liwuhou.cn/tmp/20220215163647.png)

迭代解析：主机进行域名查询时，本地服务器没有被查询域名信息，则先求助根域名服务器，根域名只是将下一步要查询的服务器告知查询主机的本地域名服务器，本地域名服务器继续查询下一个域名服务器，直到查询到被查询的域名的 ip 地址。（域名服务器不会代替查询主机或其他域名服务器进行进一步的域名查询， 只是将下一步要查询的服务器告知查询主机或服务器。）

![](http://cdn.liwuhou.cn/tmp/20220215163729.png)

## 万维网应用

### 万维网的应用结构

万维网应用包括：

-   **浏览器**： Web 应用 客户代理
-   **web 服务器：**存储用户请求浏览的 web 页面
-   **超文本传输协议（HyperText Transfer protocol ）HTTP**：客户端和服务端间交互基于的协议

统一资源定位符（Uniersal Resource Localtor, URL）：存放对象的 **主机域名**（或 IP 地址） + **对象的路径名** 例如`https://foo.com/bar.png`

### 超文本传输协议⭐

![](http://cdn.liwuhou.cn/tmp/20220215163854.png)

#### HTTP 概述

Web 应用的应用层协议，定义了浏览器如何向web 服务器发送请求，以及 web 服务器如何响应。

版本：HTTP/1.0 **HTTP/1.1** HTTP/2.0

#### HTTP 连接⭐

HTTP 基于传输层的 TCP（`Transmision Control Protocol`） 传输报文，浏览器在向服务器发送请求之前，首先建立 TCP 连接，然后才发送 HTTP 请求，接收 HTTP 响应。

**RTT**（Round Trip Time）：作为一个时间单位来使用，指HTTP 客户进程向服务器请求建立连接（从客户发送连接请求，到客户收到服务器连接确认，用时一个往返时间）

HTTP 使用 TCP 连接的两种策略：

-   非持久连接的 HTTP（**TCP 用一次就断开**，HTTP1.0常用）
    
    一次连接需要 2 个 RTT（非持久连接）一个 RTT 用来建立通路，一个 RTT 用来传输信息，**请求结束就断开连接了，下次请求又要重新建立**
    
    基于非持久连接的 HTTP 的特性，有一些改进方案：
    
    1.  并行连接：建立**多条并行的 TCP 连接**，并行发送 HTTP 请求和并行接收 HTTP 响应，然后断开 TCP 连接

持久连接的 HTTP（TCP 不断开）：

1.  非流水方式持久连接（非管道方式持久连接）：建立 TCP 连接，发送请求和接收响应后，**不断开** TCP 连接，继续请求
2.  流水方式持久连接：建立 TCP 连接后，**不断开 TCP 连接，继续并行请求**（HTTP1.1）

#### HTTP 报文

|          | 请求报文                        | 响应报文                               |
| -------- |:------------------------------- |:-------------------------------------- |
| 起始行   | 请求行：`<方法><URL><协议版本>` | 状态行：`<HTTP版本><状态码><原因短语>` |
| 首部行   | 携带附加信息                    | 携带附加信息                           |
| 空白行   | CRLF                            | CRLF                                   |
| 报文主体 | 实际要传输的内容                | 实际要传输的内容                       |

-   HTTP 报文起始行
    -   请求行
        -   方法：命令，表示客户端希望服务器对 URL 指定的资源执行的操作
        -   URL：定位所请求的资源
        -   协议版本：通告服务器客户端用的 HTTP 版本号
    -   状态行
        -   协议版本：通告服务器客户端用的 HTTP 版本号
        -   状态码：**通告客户端对请求的响应情况**，由 3 位十进制数组成
        -   短语：对状态码的进一步解释。相同状态码，不同短语，处理结果相同

| 请求方式 | 描述                                          |
|:-------- |:--------------------------------------------- |
| ** GET** | **请求读取由 URL 所标识的信息，最常见的方法** |
| HEAD     | 请求读取由 URL 所标识的信息的首部             |
| POST     | 给服务器添加信息                              |
| OPTION   | 请求一些选项的信息                            |
| PUT      | 在指明的 URL 下存储一个文档                   |


HTTP 状态码：3 位十进制数，利用第一位十进制数字区分 5 类状态码

| 状态码类 | 取值范围 | 作用           | 说明                                |
| -------- | -------- | -------------- | ----------------------------------- |
| 1xx      | 100-199  | 信息提示       | 通告信息，可能还需要进一步交互      |
| 2xx      | 200-299  | 成功           | 成功完成客户请求的操作，并进行响应  |
| 3xx      | 300-399  | 重定向         | 表示资源已移走，需要向新 URL 发请求 |
| 4xx      | 400-499  | **客户端**错误 | 由于客户端请求错误，无法成功响应    |
| 5xx      | 500-599  | **服务器**错误 | 由于服务器端错误，无法成功响应      |

| 状态码  | 短语                       | 含义                                     |
| ------- | -------------------------- |:---------------------------------------- |
| 100     | Continue                   | 已成功收到了请求的初始部分，请客户端继续 |
| 200     | Ok                         | 成功，所请求信息在响应报文中             |
| 301     | Moved Permanently          | 重定向                                   |
| 400     | Bad Request                | 客户端请求错误                           |
| 401     | Unauthorized               | 未授权，需要输入用户名和密码             |
| **404** | **Not Found**              | **客户端请求的对象，在服务器上不存在**   |
| 451     | Unsupported Media Type     | 不支持的媒体类型                         |
| 505     | HTTP Version Not Supported | 请求使用的 HTTP 版本，服务器不支持       |

### Cookies

HTTP 服务器不保存客户的数据，故被称为 **无状态协议**，而 Cookies 的机制就是用于用户跟踪

小型文本文件（Cookie）：网站为了辨别用户、进行会话跟踪而存储在 **用户本地终端** 上的数据

Cookies 技术主要包括 4 部分内容：

1.  HTTP 响应报文中的 Cookies 头行
2.  **用户浏览器** 在 **本地** 存储、维护和管理的 Cookies 文件
3.  HTTP 请求报文中的 Cookies 头行
4.  网站在后台数据库中存储、维护 Cookie 信息：分配给用户 ID、每个 ID 用户在本网站的访问特征等

## Internet 电子邮件

### 电子邮件系统结构

### 邮件服务器

电子邮件体系结构的核心

功能：

-   发送和接收邮件
-   向发信人报告邮件传送情况（已将会、被拒绝、丢失等）
-   用户注册
-   分配存储空间

#### 用户代理

电子邮件应用的客户端软件

-   Outlook
-   Apple Mail
-   Fox Mail等

支持用户撰写、显示、处理和收发邮件

为用户阅读、回复、转发、保存和撰写邮件提供编辑与操作环境

#### 简单邮件传输协议（SMTP）

SMTP（Simple Mail Transfer Protocol)：Internet 电子邮件中核心应用层协议。实现邮件服务器之间或用户代理到邮件服务器之间的 **邮件传输**

#### 邮件读取协议(POP3、IMAP、HTTP)

-   POP3（Post Office Protocol - Version 3): 第三版邮局协议
-   IMAP（Internet Message Access Protocol): 互联网邮件访问协议
-   HTTP（HyperText Transfer Protocol): Web 邮件系统的邮件读取协议

|        | IMAP                         | POP3                           |
|:------ | ---------------------------- | ------------------------------ |
| 相同点 | 邮件读取协议                 | 邮件读取协议                   |
| 不同点 | 对邮件的操作会反映在服务器上 | 对邮件的操作不会反映在服务器上 |

### SMTP简单邮件传输协议

SMTP 定义了**14 条命令**，每条命令用 4 个字母组成

-   HELO：标识发件人自己的身份
-   DATA：通知服务器准备开始发送邮件内容
-   QUIT：命令退出

SMTP 也定义了 **21 种应答信息**，一般只有一行，由 3 位数字的代码开始，后面附上（也可不附）简单的文字说明

SMTP 通过 **3 个阶段**的应用层交互完成邮件的传输

![](http://cdn.liwuhou.cn/tmp/20220118233828.png)

#### 握手阶段

SMTP 客户 C 和 SMTP 服务器 S 之间一封简单邮件传输的交互过程示例

```text
S: 220 mail.abc.com
C: HELO xyz.hit.edu.cn
S: 250 Hello xyz.hit.edu.cn,pleased to meet you
```

#### 邮件传输阶段

SMTP 客户 C 和 SMTP 服务器 S 之间一封简单邮件传输的交互过程示例

```text
C: MAIL FROM:<user_a@xyz.hit.edu.cn>
S: 250 user_a@xyz.hit.edu.cn ... Sender Ok
C: RCPT TO:<user_b@mail.abc.com>
S: 250 user_b@mail.abc.com ... Recipient Ok
C: DATA
S: 354 Enter mail,end with "." on a line by itself
C: =DATA=
C: ...
C: .
```

#### 邮件关闭阶段

SMTP客户 C 和 SMTP 服务器 S 之间一封简单邮件传输的交互过程示例

```text
S: 250 Message accepted for delivery
C: QUIT
S: 221 mail.abc.com closing connection
```

### SMTP 的特点：

-   SMTP 只能传送 7 位 ASCII 码文本内容，包括 SMTP 命令、应答消息及邮件内容
-   SMTP 传送的邮件内容中不能包含 `CRLF.CRLF` ，因为该信息用于标识邮件内容的结束
-   SMTP 是“**推动**”协议。（补充：HTTP 是“拉动”协议）
-   SMTP 使用 **TCP 连接是持久**的

传输非 7 位 ASCII 码 文本内容时，必须依据一个标准将非

### 电子邮件格式与 MIME

MIME：将非 ASCII 码文本内容转换为 ASCII 码文本内容的协议

#### 首部

| TO       | 后面收件人的电子邮件（*必填） |
|:-------- |:----------------------------- |
| Subject  | 邮件主题                      |
| Cc       | 表示应给发送一个邮件副件      |
| From     | 表示发件人的电子邮件地址      |
| Date     | 发信日期                      |
| Reply-To | 对方回信的日期                |

#### 空白

#### 行主体

互联网邮件扩展（Multipurpose Internet Mail Extensions,MIME）

传输非7位ASCII码文本内容时，必须依据一个标准将非7位ASCII码文本内容转换位7位ASCII码文本内容，然后再传输

### FTP

文件传送协议（File Transfer Protocol， FTP）： 在互联网的两个主机之间实现文件互传的网络应用的应用层协议

FTP 的应用结构：

-   主进程：负责接受新的客户请求
-   从属进程：负责处理单个客户请求，与具体的客户进行交互

控制信号：用户登录，服务器授权

数据连接：专门用于文件传输

带外控制：FTP 专门有一个独立的控制连接传输控制信息，与传输文件信息进行分离

FTP 是 **有状态**的协议

#### P2P

P2P（peer to peer）：通信双方没有传统意义上的客户服务器之分，地位对等，通信双方都具备客户和服务器的特征

例如：BitTorrent、PPlive 和 PPstream 等

应用特点：

1.  应用的对待方是用户的计算机
2.  很强的应用规模伸缩性
3.  应用在对等方之间进行
4.  应用充分聚集利用了端系统的计算能力以及网络传输宽带

### Socket 编程基础

**套接字**：典型的网络应用编程接口

**端口号**：标识套接字，一般由操作系统随机分配

| 端口号                 | 描述                        |
| ---------------------- | --------------------------- |
| 20（数据）、21（控制） | FTP 文件协议端口号          |
| 25                     | SMTP 简单邮件传输协议端口号 |
| 53                     | DNS域名服务器端口号         |
| 80                     | HTTP超文本传输协议端口号    |
| 110                    | POP3 第三版邮局协议端口号   |

套接字类型：

-   UDP 创建的套接字：数据报类型套接字（SOCK_DGRAM）
-   TCP 创建的套接字：流式套接字（SOCK_STREAM)
-   原始套接字SOCK_RAW

Socket Api 函数

1.  创建套接字：socket()
2.  绑定套接字的本地端点地址：bind()
3.  设置监听：listen()
4.  建立连接（TCP 独有）：
    -   TCP 客户端：connect()
    -   TCP 服务端：accept()
5.  接收数据：
    -   TCP: recv()
    -   UDP: recvfrom()
6.  发送数据：
    -   TCP: send()
    -   UDP: sendto()
7.  关闭套接字：close()

---

# 传输层

传输层的**核心任务：应用进程**之间提供**端到端**的**逻辑通信**服务

-   只有**主机才有传输层**
-   网络核心中间系统只用到下三层的功能（物理、链路、网络层）

## 传输层的基本服务

### 功能

> 分复流拥寻差错——可靠 吩咐刘墉寻差错——可靠

1.  对应用层的报文进行_分_段和重组
2.  面向应用层实现_复_用与分解（第二节）
3.  实现端到端的_流_量控制（第五节）
4.  _拥_塞控制（第五节）
5.  传输层_寻_址
6.  对报文进行_差错_检测
7.  实现进程间端到端_可靠_数据传输控制

### 传输层寻址与端口

传输层使用协议端口号，通常简称为端口

在全网范围内，利用 IP 地址+端口号 唯一标识一个通信端点

传输层端口号为 16 位整数，可以编号 65536 个($2^6$)

常用端口：端口号小于 256 的端口，见上节端口号表

|      0 ～ 1023 | 熟知端口号 | 服务器端口号 |
| --------------:| ---------- | ------------ |
|  1024 ～ 49151 | 登记端口号 | 服务器端口号 |
| 49151 ～ 65535 | 短暂端口号 | 客户端口号   |

### 无连接服务与面向连接服务

**无连接服务：**无需与端进行任何信息交换，直接构造传输层报文段并向接收端发送，类似于信件收发

**面向连接：**需要双方**交换一些控制信息**建立逻辑连接，然后再传输数据，传输结束后还需要拆除连接，类似于电话通信

## 传输层的复用与分解

### 多路复用和多路分解

支持众多应用进程共用同一个传输层协议，并能够将接收到的数据准确交付给 **不同的应用进程**

多路复用：在源主机，传输层协议从不同的套接字收集应用进程发送的数据块，并为每个数据块封闭上首部信息（包括用于分解的信息）构成的报文段，然后将报文段传递给网络层

多路分解：在目的主机，传输层协议读取报文段中的字段，标识出接收套接字，进而通过该套接字，将传输层的报文段中的数据交付给正确的套接字

### 无连接的多路复用和多路分解

用户数据报协议（User Datagram Protocol, UDP)：Internet 提供无连接服务的传输层协议

UDP 将应用层的数据块封装成一个 UDP 报文段

UDP 套接字二元组：<目的 IP 地址，目的端口号>

### 面向连接

传输控制协议（Transmission Control Protocol, TCP)：Internet 提供无连接服务的传输层协议

TCP 套接字四元组：<**源 IP 地址，源端口号**， 目的 IP 地址，目的端口号>

## 停-等协议与滑动窗口协议

不可靠传输信道在数据传输中可能发生：

1.  比特差错：1001 —— 1000
2.  乱序差错： 数据块 1、2、5、6、3、4
3.  数据丢失：数据块1、2、5

采取的措施：

1.  差错检测：利用编码实现数据包传输过程中的比特差错检测
2.  确认：接收方向发送方反馈接收状态。ACK（表示确认，Positive Acknoledgement），NAK（否定确认，Negative Acknowledgement）
3.  重传：发送方重新发送接收方没有正确接收的数据
4.  序号：确保数据按序提交
5.  计时器：**解决**（发现）数据丢失问题

### **停——等协议**：最简单的**自动重传协议**

差错检测、确认重传、序号、计时器 => 自动重传请求协议（Automatic Repeat reQuest, **ARQ**）

![](http://cdn.liwuhou.cn/tmp/20220215171620.png)

由于停-等协议性能差、信道利用率低，优化出来流水线协议（管道协议）：**允许发送方在没有确认前连续发送多个分组**。

最典型的流水线协议：**滑动窗口协议**

### 滑动窗口协议

1.  增加分组序号
2.  发送方和接收方可以缓存多个组合
3.  确认只采用 ACK，例如，正确接收分组 01，则返回 ACK01

发送窗口（$W_s$）：发送方可以发送未被确认分组的最大数量

接收窗口（$W_r$）：接收方可以缓存正确到达的分组的最大数量

滑动窗口协议，根据接收窗口的大小，可以具体分为：

#### GBN（Go-Back-N) 协议

$W_s$ ≥ 1 并且 $W_r$ = 1

累计确认

未按序到达的分组需要重传

![](http://cdn.liwuhou.cn/tmp/20220215171837.png)

SR（Selective Repeat） 协议

$W_s$ > 1 并且 $W_r$ > 1

逐个确认

发送方重传未被接收方确认的分组

![](http://cdn.liwuhou.cn/tmp/20220215171908.png)

![](http://cdn.liwuhou.cn/tmp/20220215171936.png)

## 用户数据报协议（UDP）

Internet **传输层**协议，提供**无连接、不可靠**、数据报尽力传输的服务

### UDP 特点

1.  应用进程容易控制发送什么数据以及何时发送，**会出现分组的丢失和重复**
2.  无需建立连接
3.  无连接状态
4.  首部开销小，只有 8 个字节（Byte）

### UDP 数据报结构

![](http://cdn.liwuhou.cn/tmp/20220215172013.png)

UDP 数据报首部：源端口号、目的端口号、长度和校验和（拢共 8 个字节）

UDP 数据报数据：应用数据

-   源端口号和目的端口号：UDP 实现复用和分解
-   长度：指示 UDP 报文段中的字节数（首部和数据的总和）
-   校验和：接收方使用来检测数据是否出现差错
-   应用数据：应用层数据占用

### UDP 校验和

接收方用来检测数据报是否出现差错（通过计算）

UDP 校验和计算规则（TCP 的校验和也是这么计算）

1.  所有参与运算的内容按 **16 **位对齐求和
2.  求和过程中遇到溢出（即进位）都被**回卷**（即进位与和的最低位再相加）
3.  最后得到的和**取反码**，就是 UDP 的校验和，填入到UDP 数据报的校验和字段

> UDP校验和计算的内容包括 3 部分：**UDP 伪首部**、**UDP 首部**、**应用数据**

UDP 伪首部长这样

![](http://cdn.liwuhou.cn/tmp/20220215172125.png)

-   源 IP 地址、目的地址、协议号：对应封装 UDP 数据报的 IP 分组的字段
-   UDP长度：该UDP数据报的字段，也就是说该字段会参与计算两次，不参与封装对应 UDP 数据报的 IP 分组对应字段
-   UDP 协议号：17

## 传输控制协议 （TCP）

Internet 传输层协议。提供**面向连接、可靠、有序**的字节流传输服务

1.  应用进程先建立连接
2.  每一条 TCP 连接**只有两个端点**
3.  可靠交付：无差错，不丢失，不重复，按序到达
4.  全双工通信

流：序列。应用程序和 TCP 的交互是一个个数据块，TCP 把他们看做是无结构字节流

### TCP 报文段结构

TCP 报文首部最多 60 个字节，**其中固定首部为 20 个字节，即最少 20 个字节**

![TCP 报文结构](http://cdn.liwuhou.cn/tmp/20220215172115.png)

1.  源端口号字段，目的端口号字段：占 16 位。复用和分解上层应用的数据
2.  序号字段：TCP 的序号是对每个应用层数据的**每个字节**进行编号⭐
3.  确认序号字段：**期望**从对方接收数据的字节序号，即该序号对应的字节尚未收到⭐
4.  首部长度字段：占 4 位，指出 TCP 段的首部长度，以 4 字节为计算单位，如首部长度字段值是 15，则这个 TCP 报文长度为 15∗4=6015 * 4 = 6015∗4=60，而固定首部恒为 20，则选项字段的_最大长度_也能算出来： 60−20=4060 - 20 = 4060−20=40
5.  首部保留字段：占 6 位，保留为今后使用，目前值为 0
6.  URG、ACK、PSH、RST、SYN、FIN 各占 1 位，为标志位字段，取值 0 或 1
    -   URG： Urgent——紧急，紧急指针有效时，优先传送
    -   ACK： Acknowledge——确认
    -   PSH： Push——推送，尽快将报文段中的数据交付接收应用进程，不要等缓存满了再交付
    -   RST： Rest——复位，TCP 连接出现严重差错，释放连接，再重新建立 TCP 连接
    -   SYN： Synchronous——同步，该 TCP 报文段是一个建立新连接请求控制段或者同意建立新连接的确认段
    -   FIN：Finish——终止，TCP 报文段的发送端数据已经发送完毕，请求释放连接
7.  接收窗口字段：占 16 位，向对方通告我方接收窗口大小。实现 TCP 流量控制
8.  校验和：占 16 位，计算方法同 UDP 检验和
9.  紧急指针：当 URG 标志位为 1 时，才有效，指出在本 TCP 报文段中紧急数据共有多少字节
10.  选项字段长度可变，最短 0 个字节，最长为 40 个字节
11.  填充字段：取值全为 0，目的是为了整个首部长度是 4 字节的整数倍

![](http://cdn.liwuhou.cn/tmp/20220215172149.png)

### TCP 协议的基本操作
TCP 协议有这么几个基本操作
- 一个 Host 主动向另一个 Host 发起连接，称为 SYN（Synchronization），请求同步
- 一个 Host 主动断开连接，称为 FIN （Finish），请求完成
- 一个 Host 给另一个 Host 发送数据，称为 PSH （Push），数据摄推送。

而且以上三种情况中，接收方在收到数据后都要给发送方回一个 ACK（Acknowledgement）的响应，表示自己已收到请求，如果一个请求没有响应，发送方会认为自己请求丢失了，会准备重发这个请求。这正是 tcp 可靠性的保证。

从这个角度去理解的话，也可以知道为啥会有三次握手了

![](http://cdn.liwuhou.cn/tmp/20220407184708.png)

### TCP 连接的建立和拆除

TCP 连接的建立——三次握手

**第一次握手**：

客户端向服务器发送连接请求：（SYN=1,seq=x）

SYN = 1：建立连接请求控制段

seq = x：表示传输的报文段的第 1 个数据字节序列号是 x，此序列号代表整个报文段的序号

补充：（sequence number，序号的意思）

客户端进入 SYN_SEND（同步发送）状态

**第二次握手**：

服务器发回确认报文段：（SYN=1,ACK=1,seq=y,ack_seq=x+1）

SYN=1：同意建立新连接的确认段

ACK=1：确认序号字段有效

seq=y：服务器告诉客户确认报文段的序列号是 y

ack_seq=x+1：表示服务器已经收到序列号为 x 的报文段，准备接收序列号为x+1 的报文段

服务器由 LISTEN 进入 SYN_RCVD（同步收到）状态

**第三次握手**：

客户端对服务器的「同意连接报文段」进行确认：（ACK=1,seq=x+1,ack_seq=y+1）

ACK=1：确认序号字段有效

seq=x+1：客户此次的报文段的序列号是 x+1

ack_seq=y+1： 客户端下次期望接收到的服务器报文序列号为y+1

当客户发送 ACK 时，客户端进入 ESTABLISHED 状态——连接建立

当服务器收到 ACK 后，也进入 ESTABLISHED 状态

**第三次握手可以携带数据了**

A: 为什么一定是三次握手，不能多也不能少

Q: 三次握手就是**客户端跟服务器互相确认双方是否都具有正常收发数据的能力**，三次是最少的方式

1.  第一次握手：客户端发起连接请求，此时服务器知道客户端 _发送功能正常_
2.  第二次握手：服务器发送确认，此时客户端知道服务端 _发送功能正常_和 _接收功能也正常_
3.  第三次握手：客户端发送确认，此时服务端知道客户端 _接收功能正常_

#### TCP 连接的拆除——四次挥手

**第一次挥手**：

客户端向服务器发送释放连接报文段：（FIN=1,seq=u）

FIN=1：发送端数据发送完毕，请求释放连接

seq=u：传输的第一个数据字节的序号是 u

客户端状态从 ESTABLISHED 进入 FIN_WAIT_1（终止等待1状态 ）

**第二次挥手**：

服务器向客户端发送确认段：（ACK=1,seq=v,ack_seq=u+1）

ACK=1：确认序号段有效

ack_seq=u+1：服务器期望接收客户数据序号为 u+1

seq=v：服务器传输的数据序号是 v

服务器状态由 ESTABLISHED 进入 CLOSE_WAIT（关闭等待）

客户端收到ACK字段后，由FIN_WAIT_1进入 FIN_WAIT_2 状态

**第三次挥手**：

服务器向客户端发送释放连接报文段（FIN=1,ACK=1,seq=v+1,ack_seq=u+1)

FIN=1：请求释放连接

ACK=1：确认序号段有效

seq=v+1：表示传输的第一个数据字节的序号是 v+1

ack_seq=u+1：表示服务器期望接收客户端数据序号为u+1+1

服务器由CLOSE_WAIT状态进入LACK_ACK（最后确认）

**第四次挥手**：

客户向服务器发送确认段：（ACK=1,seq=u+1,ack_seq=v+1+1)

ACK=1：确认序号字段有效

seq=u+1：表示客户端传输的数据的序号是 u+1

ack_seq=v+1+1：表示客户端期望接收服务器的数据序号是 v+1+1

客户端发送之后状态从 FIN_WAIT_2 进入 TIME_WAIT，等待 2MSL 时间，进入 CLOSED 状态

服务器在收到最后一次 ACK 后，由LAST_ACK进入 CLOSED 状态

### TCP 可靠传输

-   可靠：保证接收方应用进程从缓冲区读出的字节流与发送方发出的字节流是完全一样的
    
    保证实现可靠数据传输服务的工作机制：
    
    1. **分段**： 应用层数据被分割成TCP认为最适合发送的数据块。
        
        最大报文段长度（Maxium Segment Size，MSS）：报文段中封装的应用数据的最大长度
        
    2.  **序号**：发送方对发送的数据包进行编号，确保数据按序提交给接收方。
        
        序号：一个字节占用一个序号。序号字段指的就是一个报文段第一个字节的序号
        
    3.  **确认**：接收方向发送方反馈接收状态，确认是否正确接收数据。
        
        采用累积确认，例如：
        -   接收方正确接收了 123，此时返回确认序号 _4_
        -   接收方正确接收了 123 和 6，此时 4 和 5 也来了，此时返回确认序号为 _7_
        
    4.  **差错检测**：利用差错编码实现数据包传输过程中的比特查错检测（甚至纠正）。
        
    5.  **重传** ：发送方重新发送接收方没有正确接收的数据。
      1. 发送方重新发送接收方没有正确接收的数据
      2. 针对两类事件：三次重复确认和计时器超时
        
    6.  **计时器**：在发送方引入计时器，**解决数据丢失问题**。

计时器超时的时间设置
    $$ TimeoutInterval = EstimatedRTT + 4 * DevRTT $$
 `EstimatedRTT` : 抽样 RTT 的加权移动平均值
 `DevRTT`: 偏差 RTT

 #### TCP生成 ACK 的策略
 1. 具有所期望序号的报文段按序到达，所有在期望序号及以前的报文段都已被确认。TCP 延迟 500ms 发送 ACK
 2. 具有所期望序号的报文段按序到达、且另一个按序报文段在等待 ACK 传输。TCP 接收方立即改善单个累计 ACK，确认以上两个按序到达报文段。
 3. 拥有序号大于期望序号的失序报文段到达
 4. 收到一个报文段部分或完全填充接收数据间隔

### 流量控制
**协调发送方与接收方的数据发送与接收速度**
在通信过程中， 接收方设置报文段的**接收窗口字段**来将窗口大小通知给发送方

### 拥塞控制
造成拥塞的原因：太多的主机以太快的速度向网络中发送了太多的数据，超出了网络处理能力，导致大量数据分组拥挤在蹭设备队列中等待转发，网络性能显著下降的现象

拥塞控制：通过合理调度、规范、调整向网络中发送数据的主机数量、发送速率、数据量，以避免拥塞或消除已发生的拥塞。
一句话讲晒，拥塞预防策略即流量整形技术：规范网络中的主机向网络发送数据的流量

一些概念

拥塞窗口（CongWin）：连接开始时，CongWin = 1Mss（MSS: 1 个最大报文段长度（Maximum Segment Size)
阈值（Threshold）： 临界值
判断报文段丢失：是否经过三次重传？定时器是否超时？


TCP 拥塞控制的算法：
- 慢启动：在 TCP 连接建立时，窗口初始值为 1MESS，每经过一个 RTT 拥塞窗口就增大一倍，阈值为 16MESS
- 拥塞避免：当拥塞窗口大于或等于阈值时，每经过 1 个RTT，拥塞窗口的值加 1
- 快速重传：接收端收到 3 次重复确认，则推断被重复确认的报文段已经丢失，于是立即发送需要重传的报文段
- 快速恢复：当发生 3 次重复确认时，网络拥塞程度

> 快速重传和快速恢复解决的是 *三次重复确认和计时器超时* 的问题

[[TCP 中的拥塞控制]]

![](http://cdn.liwuhou.cn/tmp/20220304082122.png)

# 网络层
网络层的任务为将数据从源主机运输到目的主机，是网络层的主要任务

## 网络层服务
- **转发**：当输入链路接收到一个分组后，路由器将决策通过哪条链路将分组发送出去，并将分组从输入接口转移到输出接口
- **路由选择**：当分组从源主机流向目的主机时，必须通过某种方式决定分组经过的路由或路径
- **连接建立**：网络层连接是指从源主机到目的主机经过的一条路径，这条路径经过的每个路由器等网络设备都要参与网络层连接的建立

## 数据报网络与虚电路网络
数据报网络和虚电路网络都属于分组交换网络，数据报网络是无连接报务，而虚电路为面向连接的报务


### 数据报网络
  由于数据报网络是无连接的报务，所以每次源主机要向目的主机发送一个包的时候，都要带上目的主机的地址，然后将该分组推进网络，每个路由器使用分组的目的主机地址转发分组。因特网使用的就是数据报网络服务


### 虚电路网络
源主机与目的主机会在经过路径建立一条网络层逻辑上的连接，由于这条电路是逻辑上的，不是实实在在的电路，所以称为虚电路网络。是网络层提供的一种面向连接的分组交换服务，双方通信前会建立连接，通信结束之后再拆除连接。

#### 虚电路（VC）建立的三要素
1. 从源主机到目的主机之间的一条路径（一系列的链路和分组交换机）
2. 该路径上的每条链路的虚电路标识（VCID）
3. 分组交换机的转发表中记录虚电路标识的接续关系 

![](http://cdn.liwuhou.cn/tmp/20220818071614.png)

#### 数据报网络与虚电路的对比

| 项目         | 数据报网络                   | 虚电路                                           |
| ------------ | ---------------------------- | ------------------------------------------------ |
| 是否建立连接 | 不建立连接                   | 建立连接                                         |
| 地址         | 每个分组包含源地址和目的地址 | 每个分组含有一个短的虚电路号                     |
| 分组顺序     | 按序发送，不一定按序接收     | 按序发送，按序接收                               |
| 路由选择     | 每个分组独立选择路由         | 建立VC时需要路由选择，之后所有分组都沿此路由转发 |
| 典型网络代表 | 因特网                       | ATM、帧中继、X.25                                |

## 网络互连与网络互连设备

### 异构网络
主要是指两个网络的通信技术和运行协议不同，例如：wifi 和 网络等

#### 异构网络之间如何实现互连
实现互连的基本策略：协议转换和构建虚拟互连网络

**协议转换**
采用一种支持异构网络之间协议转换的网络中间设备，来实现异构网络之间数据分组的转换与转发，例如：交换机和多协议路由器。


**构建虚拟互连网络**
在异构网络的基础上构建一个同构的虚拟互连网络

##### 路由器
路由器是最典型的网络层设备，具有多个输入端口和多个输出端口的专用计算机，主要任务是获取和收集路由信息与转发分组

路由器从功能体系结构的角度可分为：输入端口、输出端口、交换结构、路由处理器。

**输入端口**：**查找**、**转发**、到达分组、**缓存排队**功能

![](http://cdn.liwuhou.cn/tmp/20220818081720.png)

**交换结构**：完成具体转发工作，将输入端口的IP数据报交换到指定的输出端口。
交换的方式主要有三种：**基于内存交换**、基于总线交换和**基于网络交换**

**基于内存交换**
输入端口——内存、路由处理器——输出端口，**是性能最低，但造价最便宜的交换结构**

![](http://cdn.liwuhou.cn/tmp/20220818082011.png)

**基于总线交换**
输入端口和输出端口连接在一总线上，无须路由器介入就可以实现交换功能，缺点是独占式，效率较低
![](http://cdn.liwuhou.cn/tmp/20220818082518.png)

**基于网络交换**
使用一个复杂的互联网络来实现交换结构，能克服单一、独占带来的限制，实现并行的交换传输，**是性能最好，同时也是造价最高的一种交换结构**

![](http://cdn.liwuhou.cn/tmp/20220818082825.png)

**输出端口**：缓存排队，从队列中取出分组进行数据链路层数据帧的封装和发送。
输出端口的调度策略
1. 按照先到先服务(First Come First Serve, FCFS)的调度策略
2. 按优先级调度、按 IP 数据报的服务类型调度

![](http://cdn.liwuhou.cn/tmp/20220818083243.png)

**路由处理器**
路由处理器是路由器的大脑

1. 执行命令
2. 路由协议运行
3. 路由计算以及路由表的更新和维护

## 网络层拥塞控制(重要)

网络拥塞是一种持续过载的状态，用户对网络资源（包括链路带宽、存储空间和处理器处理能力等）的总需求超过了网络的固有容量。

![](http://cdn.liwuhou.cn/tmp/20220819075510.png)

网络负载在膝点附近时，吞吐量和分组平均延迟达到理想的平衡，网络的**使用效率最高**

发生网络拥塞的原因：
- 缓冲区的容量有限
- 传输线路的带宽有限
- 网络结点的处理能力有限
- 网络中某些部分发生了故障

### 拥塞控制

网络层常采用的拥塞控制措施：

- 流量感知路由
- 准入控制
- 流量调节
- 负载脱落

#### 流量感知路由

网络会被抽象为一张**带权无向图**，权值能够通过网络负载动态地调节，则可以将网络流量引导到不同的链路上，均衡网络负载，从而延缓或避免拥塞的发生。

#### 准入控制

一种针对网络层拥塞的预防措施，且针对虚电路
针对虚电路，对新建虚电路进行审核，如果建立的新电路会导致网络变得拥塞，那么网络拒绝建立该新电路

#### 流量调节

在网络拥塞时，通过调整发送方发送抑制分组数据的速率来消除拥塞

**抑制分组**：感知到拥塞的路由器，随机选择一个数据报，先该数据报的源主机发送一个抑制分组

**背压**：抑制分组在从拥塞路结点到源结点路径上的每一跳，都会发挥抑制作用（同步拥塞结点的拥塞情况给途径的每一跳路由器）

#### 负载脱落

通过有选择地主动丢弃一些数据报，来减轻网络负载，从而缓解或消除拥塞，一般选择序号大的数据报进行丢弃

## Internet 网络层

网络层的主要协议：

- 网络协议（Internet Protocol, IP）
- 路由协议
- 互联网控制报文协议（Internet Control Message Protocol, ICMP）

### IPv4 协议
Internet **网络层最核心的协议**
  - 定义了如何封装上层协议（如TCP、UDP）报文段
  - 定义了 Internet 网络层寻址(IP 地址) 以及如何转发IP数据报等内容

IP 目前两个版本：IPv4协议、IPv6协议

#### IP数据报格式

![](http://cdn.liwuhou.cn/tmp/20220823082948.png)

**版本号**：4位、用以标识 IPv4、IPv6
**首部长度**：4位，20B
区分服务：在旧标准种称为服务类型(Type Of Service,TOS)字段 用来指示期望获得哪种类型的服务。
数据长度：16位，指出数据报总字节数，首部+数据的长度
**标识**： 占16位，标识一个IP数据报，每产生一个 ip 数据报，ip 协议的计数器+1，在ip数据报的**分片**和**重组**中，用于标识属于同一ip数据的重要标识。光看该字段的话，是不可唯一标识一个ip数据报
**标志**：占3位，结构如下
![](http://cdn.liwuhou.cn/tmp/20220906071208.png)
片偏移量：占13位，以8B为单位，表示一个ip数据报分片与原ip数据报的相对偏移量，当该数值为0时，且MF=1，则表示这是一个分片，且为第一个分片。
![](http://cdn.liwuhou.cn/tmp/20220906071431.png)
生存时间：占8位，表示IP数据报在网络中可以通过的路由器数（或称跳数）
上层协议：占8位，指该IP数据报封闭的是哪个上层协议，TCP：6，UDP：17
首部校验和：16位，利用校验和实现对IP数据报首部的差错检测
源IP地址：32位，源主机的ip地址，ipv6 占 128位
目的IP地址：32位，目的主机的ip地址，ipv6 占 128位
选项：长度是可变的，导致ip数据报首部长度变化的原因
数据：存放IP数据报所封装的传输层报文段

最大传输单元（MTU）：一个数据链路层协议帧所能承载的最大数据量

![](http://cdn.liwuhou.cn/tmp/20220906090405.png)

做这类题的步骤
1. 确定每个分片最多可以封闭多少字节的数据
2. 确定分片数
3. 标志位
4. 片偏移量（单位是8个字节）


### IPv4 编址

ipv4 地址的长度为32位（ipv6为128位），共有 $2^{32}$ 个不同的ip地址，约为43亿个。

#### IPv4的三种标记方式

| 方法                     | 表示方法                            |
| ------------------------ | ----------------------------------- |
| 二进制标记法             | 11000000 10101000 00000001 01100101 |
| 点分十进制标记法（常用） | 192.168.1.101                       |
| 十六进制标记法           | 0xC0A80165                          |

#### IP 地址分配

因特网中的路由器和主机的网络接口都必须有唯一的ip地址

ip地址由前缀和后缀组成。

前缀即为网络部分，又称网络ID，用于描述主机所归属的网络。
  - 分类地址：定长前缀（A、B、C、D、E类）
  - 无类地址：前缀长度可变

后缀也就是主机部分，又称主机ID，用于表示主机在网络中的唯一ID

| 类  | 前缀长度 | 前缀                                | 前缀中固定位数 | 首字节（十进制数） |
|:---:|:--------:|:----------------------------------- |:--------------:|:------------------:|
|  A  |   8位    | 0xxxxxxx                            |    1位（0）    |       0-127        |
|  B  |   16位   | 10xxxxxx xxxxxxxx                   |   2位（10）    |      128-191       |
|  C  |   24位   | 110xxxxx xxxxxxxx xxxxxxxx          |   3位（110）   |      192-223       |
|  D  |  不可用  | 1110xxxx xxxxxxxx xxxxxxxx xxxxxxxx |                |      224-239       |
|  E  |  不可用  | 1111xxxx xxxxxxxx xxxxxxxx xxxxxxxx |                |      240-255       |

A、B 和 C 类地址可以用来标识网络中的主机或路由器
D 类是组广播地址
E 类地址是保留地址，做研究

#### 特殊地址

分类地址中的一些特殊用途的地址

| 网络部分 | 主机部分             | 作为ip数据报源地址 | 作为ip数据报目的地址 | 用途                                                                    |
| -------- | -------------------- | ------------------ | -------------------- | ----------------------------------------------------------------------- |
| 全0      | 全0                  | 可以               | 不可以               | 在本网范围内表示本机（0.0.0.0/32);在路由表中用于表示默认路由(0.0.0.0/0) |
| 全0      | 特定值               | 可以               | 不可以               | 表示本网内某个特定的主机                                                |
| 全1      | 全1                  | 不可以             | 可以                 | 本网中的广播地址                                                        |
| 特定值   | 全0                  | 不可以             | 不可以               | 表示一个网络地址（子网地址）                                            |
| 特定值   | 全1                  | 不可以             | 可以                 | 直接广播地址，对特定网络上的所有主机进行广播                            |
| 127      | 非全0或非全1的任何数 | 可以               | 可以                 | 环回地址，用于本地软件环回测试                                          |

#### 私有地址
一部分分类地址保留用于内部网络的ip地址，这部分分类地址可以在内网使用，不能在公共互联网上使用。

| 私有地址类别 | 范围                                          |
| ------------ | --------------------------------------------- |
| A类          | 10.0.0 ~ 10.255.255.255(10.0.0.0/8)           |
| B类          | 172.16.0.0 ~ 172.31.255.255(172.16.0.0/12)    |
| C类          | 192.168.0.0 ~ 192.168.255.255(192.168.0.0/16) |


#### 子网划分
**超网化**：将具有较长前缀的相对较小的子网合并为一个具有稍短前缀的相对较大的子网（小变大）
**子网化**：将一个较大的子网划分为多个较小的子网
**子网掩码**： 定义一个子网的网络前缘长度，子网掩码为 32 位，书写形式有二进制和点分十进制，对应的前缘全为 1，后缀全为 0
**网络地址**：也称子网地址，网络位是特定值，而主机位全为 0
**广播地址**：网络位为特定值，主机位全为 1

已知某个网络的主机ip 地址与该网络的子网掩码，即可求出该子网的子网地址、子网广播地址、IP 地址总数及可分配的 IP 地址数量。

> 假设某子网中的一个主机的IP地址是203.123.1.135，子网掩码是255.255.255.192。

**求子网地址**：已知的某个主机 IP 地址与子网掩码进行按位与运算

$$203.123.1.135 \& 255.255.255.192 = 203.123.1.128 = 203.123.1.128/26$$

**求子网广播地址**：已知的某个主机 IP 地址与子网掩码的反码进行按位或运算

$$203.123.1.135 \| 0.0.0.191 = 203.123.1.191$$
 因为主机位全为 1 就是子网的广播地址，所以也可以根据子网地址跟子网掩码推导出来

**IP 地址总数**：子网内的 IP 地址总数为 $2^{(32-网络位)}$
$$2^{(32-26)}=2^6=64$$
即从`203.123.1.128~203.123.1.191`

**可分配的IP地址**：可分配给子网中的主机的 IP 地址（去掉网关和广播地址）也就是$2^{(32-网络位)}-2$
$$2^{(32-26)}-2=62$$
也就是可分配的 IP 地址为`202.123.1.129~202.123.1.190`


#### 路由聚合
减少路由表项数，提高路由效率，将可以聚合在一直的子网聚合成一张大一点的子网

| 网络地址         | 下一跳地址 | 接口 |
| ---------------- | ---------- | ---- |
| 16.65.154.0/26   | A          | S1   |
| 16.65.154.64/26  | A          | S1   |
| 16.65.154.128/26 | A          | S1   |
| 16.65.154.192/26 | A          | S1   | 

合并成

| 网络地址       | 下一跳地址 | 接口 |
| -------------- | ---------- | ---- |
| 16.65.154.0/24 | A          | S1   | 

#### 动态主机配置协议

与静态分配的手动配置不同，动态主机配置协议 DHCP（Dynamic Host  Configuration Protocol）会自动对 host 进行地址分配
DHCP 服务器端口号 67，DHCP 客户端口号为 68

第一步：需要分配 ip 地址的主机通过广播的形式发现DHCP 服务器
第二步：DHCP 服务器通过广播的形式提供ip 地址给主机，也因此能告诉网络中的其它的 DHCP 服务器
第三步：host 主机通过广播的形式告知网络中所有的 DHCP 服务器请求地址
第四步：提供 ip 地址的 DHCP 服务器单独发送确认信息给 host 主机

#### 网络地址转换

由于 ipv4 地址池的有限性，诞生出了一种可以使私网地址在公共 Internet 上通信的技术，称为 NAT 技术

第一步：从内网出去的 IP 数据报，将其 IP 地址替换为 NAT 合法的公网 IP 地址，并将关系记录在 **NAT 转换表**
第二步：从公共互联网返回的 ip 数据报，通过目的地址检索 NAT 转换表，并利用查到的私有ip 地址替换为目的 ip 地址，然后将数据报转发给内部网络

#### 互联网控制报文协议
Internet Control Message Protocol（ICMP）：进行主机或路由器间网络层的差错检测和网络探测

- 差错报告报文
  - 终点不可达
  - 源点抑制
  - 时间超时
  - 参数问题
  - 路由重定向

- 询问报文
  - 回声请求/应答
  - 时间缀请求/应答

#### IPv6

IPv6 相比 IPv4 的数据报首部有如下区别

- IPv6 删除了这些字段
  - 分片相关字段（也就是 IPv6 的数据报不分片）
  - 首部检验和
  - 选项字段不是 IPv6 的基本首部的字段
- IPv6 的地址长度为 **128 位**
- IPv6 地址的表示方式：
  - 8 组冒号分隔的十六进制数：`8000:0000:0000:0000:4321:0501:AB96:56CD`
  - 其中连续的 0000 可以使用双冒号 `::` 表示：`8000::4321:0501:AB96.56CD`
  - 双冒号只能出现一次
  - IPv6 地址中可以嵌入点分十进制：`6700::89A1:0321:206.36.45.19`

IPv6 地址的分类

- 单播地址：可做源地址可做目的地址
- 组播地址：只可做目的地址
- 任播地址：只可做目的地址


IPv6 到 IPv4 的迁移
1. 双协议栈：网络结点同时具备发送和处理 IPv6 与 IPv4 数据报的能力
2. 隧道：通信源端与目的端都支持 IPv6 协议，但是途径一段 IPv4 网络

隧道技术很好的解决了 IPv6 通信中经过 IPv4 路由器的问题，同时也不会出现信息丢失的问题


### 路由算法与路由协议

路由选择：如何为网络分组从源端到目的源的传输确定最佳路径，言简意赅地说就是**能走通，且最短。**

#### 路由选择算法的分类

将网络抽象为一张带权有向图 $G=(N,E)$，N 表示结点，E 是边的集合。网络中的路由器抽象为 G 的结点，连接两个网络的链路抽象为 G 的边。
网络链路的费用（比如时延）抽象为 G 中的权值。

![](http://cdn.liwuhou.cn/tmp/20221001213147.png)

如果两个结点有边，例如从结点 X 到结点Y，则从结点 X 到结点 Y 的费用为 $C(X, Y)=10$
如果两个结点没有边，则从结点X 到结点 U 的费用为 $C(X, U)=∞$

#### 路由算法的分类标准

- 是否需要全局信息：
  - 需要：
    - 全局路由选择算法
      - 链路状态路由选择算法（LS 算法）
  - 不需要
    - 分布式路由选择算法
      - 距离向量路由选择算法（DV 算法）
  - 静态还是动态
    - 静态
      - 人工配置
    - 动态
      - 网络发生变化，自动计算获取
        - LS 算法和 DV 算法
  - 是否敏感
    - 是
      - 负载敏感的路由选择算法
    - 否
      - 负载迟钝的路由选择算法

#### 链路状态路由选择算法
LS 算法是一个全局式跌幅选择算法，每个路由器在计算路由时，都需要构建出整个网络的拓扑图
利用 Dijkstra 算法求最短路径

| 表示     | 含义                                                                                     |
| -------- | ---------------------------------------------------------------------------------------- |
| $D(v)$   | 到本次迭代为止，源结点（计算结点）到目的结点 v 的当前路径距离                            |
| $P(v)$   | 到本次迭代为止，源结点到目的结点 v 的当前路径上，结点 v 的前序结点                       |
| $c(x,v)$ | 结点 x 与结点 y 之间直接链路的费用，如果 x 与 y 之间没有链路相连，则 $c(x,v)=∞$          |
| S        | **结点的集合**，用于存储从源结点到该结点的最短路径已求出的结点集合。初始值只有源结点本身 |


#### 距离向量路由选择算法
DV 算法是典型的分布式算法，可以不需要构建出整个网络的拓扑图就可打到最低费的路由，基于 `Bellman-Ford`方程（简称 BF 方程）
令结点 $d_x(y)$ 表示结点 x 到 y 的路径的最低费用，根据 BF 方程，有以下公式：
$$d_x(y)=min\{c(x,v)+d_v(y)\}$$
v 表示 x 的邻居

![](http://cdn.liwuhou.cn/tmp/20221001220026.png)

图中 x 到 z 的路径可表示为

$$d_x(z) = min\{ c(x,z) + d_z(z), c(x,y) + d_y(z) \}$$

即等于 $d_x(z) = min\{ 7 + 0, 2 + 3 + 0 \} = 5$

$d_x(y)$又称为 x 的距离向量

路由器会分别维护自己的转发表（DV），并且会收到邻居（与当前路由器直接相连的其它路由器）的通告。收到通告后会进行对比更新自己的 dv 表。

![](http://cdn.liwuhou.cn/tmp/20221001221001.png)

#### 层次化路由选择
合理的网络规模内可以使用 LS 算法和 DV 算法计算路由，而大规模的网络路由该采用什么方案才好呢？
**层次化路由**就是大规模网络路由选择最有效可靠的解决方案

层次化路由选择的原理是将大规模互联网分为两层：
1. 自治内系统的路由选择：计算到达自治系统内目的地址的路由
2. 自治外系统的路由选择：负责计算其他自治系统网络的可达性信息

![](http://cdn.liwuhou.cn/tmp/20221003094319.png)

##### 自治系统（Autonomous System, AS）
互联网按边界划分为多个自治系统，每个自治系统由**相同**路由协议和路由选择算法的路由器构成


##### 网关路由器
每个自治系统至少存在一个与其他自治系统互连的路由器

#### Internet 路由选择协议

层次化路由选择协议分为内部和外部的路由选择协议

- 内部网关协议（IGP）：Internet 自治系统内部路由选择协议（Interior Gateway Protocol）
  - 路由信息协议（RIP）：Routing Information Protocol
    - 适用于较小的 AS 中
    - 基于距离向量路由选择算法（DV）的 IGP
    - 封装在 UDP 数据报
    - RIP 的特性：
      1. RIP 度量路径采用跳数
      2. RIP 费用定义在源路由器和目的子网之间
      3. RIP 被限制在网络直径不超过 15 跳的自治网络中使用

  - 开放最短路径协议（OSPF）：Open Shortest Path First
    - 适用于较大的 AS 中
    - 基于链路状态路由算法（LS）的 IGP
    - 直接封装在 IP 数据报中传输
    - OSPF 的优点：
      1. 安全
      2. 支持多条相同费用的路径
      3. 支持区别化费用度量
      4. 支持单播路由和多播路由
      5. 分层路由

- 外部网关协议（EGP）：Internet 自治系统外部路由选择协议（Exterior Gateway Protocol）
  - 边界网状协议（BGP）：Border Gateway Protocol
    - 实现跨自治系统的路由信息交换，典型的版本是 BGP4
      - BGP 封装进 TCP 报文段
      - BGP 主要有四种报文
        1. OPEN（打开）报文
        2. UPDATE（更新）报文
        3. KEEPALIVE（保活）报文
        4. NOTIFICATION（通知）报文

##### 三种协议的对比

| 协议名称 | 封装      | 适用范围  |
| -------- | --------- | --------- |
| RIP      | UDP数据报 | 较小的 AS |
| OSPF     | IP数据报  | 较大的 AS |
| BGP      | TCP报文段 | 跨 AS     |

# 数据链路层与局域网

## 数据链路层服务
负责一条链路，从一个结点向另一个物理链路直接相连的相邻结点传输网络层数据报，中间不经过任何其他的交换结点，称为数据链路层。
而数据链路则是由网络中两个结点之间的逻辑通道，实现控制传输协议的硬件（网卡）和软件加到链路上构成。

数据链路层的传输单元：帧

数据链路层提供的服务：
- 组帧：数据链路层提供的封装能力
  - 帧头（帧首）：发送结点和接收结点的**地址信息**、**定界字符**
  - 帧尾：用于差错检测的差错编码
  - ![](http://cdn.liwuhou.cn/tmp/20221003110114.png)
- 链路接入
  - 物理链路可以分为点对点链路和广播链路
- 可靠交付
  - 无线链路：出错率高，支持可靠的数据传输
  - 光纤、双绞线：出错率低，不提供可靠的数据传输服务
- 差错控制
  - 数据链路层中的帧在物理传输链路中的传播过程中，可能会出现比特翻转的差错
  - 误比特率：$出现差错的比特数/总传输的比特数$

## 差错控制

### 噪声
在信号传输的过程中，会受到各种噪声的干扰，从而导致传输出现差错
1. 随机噪声：随机差错或独立差错
2. 冲击噪声：
  1. 突发差错：打雷、强磁场干扰等造成的差错
  2. 突发长度：突发错误发生在第一位与最后一位错误之间的长度

### 差错编码的分类
通过差错编码技术，实现对传输中差错的检测，并基于某种机制运行差错纠正和处理

1. 检错重发（用到了检错编码）
  1. 发送端：对发送数据进行差错编码，并发送
  2. 接收端：利用差错编码对数据进行检错，如果出现了错误，就让发送端重发数据，加以纠错
2. 前向纠错（用到了纠错编码），适用于单式链路
  1. 发送端：对数据进行纠错编码，然后发送
  2. 接收端：收到数据，利用纠错编码进行检错并纠错
3. 反馈检验（不用编码）
  1. 接收端：接收到发送端发送的数据之后，原封不动的发送回给发送端
  2. 发生端：接收到接收端反馈的数据，确认接收端是否正确接收已发送的数据，如果没有，则重发
  3. 优点：原理简单、易实现，无须差错编码
  4. 缺点：需要相同的传输能力的反向信道，传输效率差，实时性差
4. 检错丢弃（用到了检错编码）
  1. 为了保证网络传输的实时性，不对数据进行纠错，只是对传输的数据进行检错，如果有错误直接丢弃
  2. 优点：适用于传输实时性高的系统

### 差错编码的基本原理
在待传输的数据信息基础上，附加一定的冗余信息，与数据信息建立某种联系（复制一次或者复制两次）
例如原信息 `10`，复制一次即为`1010`，复制两次即为`101010`

#### 差错编码的检错和纠错能力
编码集：差错编码所有有效码字的集合。
`10` 的编码集 {1010, 0101, 1111, 0000}

汉明距离：两个等长码字之间，对应位数不同的位数
码字 1：**01100**101
码字 2：**10011**101
即汉明距离为 $d_c=5$

编码集的汉明距离：编码集中任意两个码字之间的汉明距离的最小值，记为$d_s$
  编码集 { 1010, 0101, 1111, 0000 }
  则编码集中的汉明距离为 $d_s=min\{4, 2, 2, 2, 4\} = 2$

差错编码：检错码和纠错码

##### 检错编码
编码集的汉明距离 $d_s=r+1$，则该检错编码可以检测 `r` 位的差错
例如：发送 2 位数据信息，冗余信息是数据的一次复制
编码集则为 { 0000, 0101, 1010, 1111 }
编码集汉明距离为 $d_s=2$
因此可以检测 1 位的差错

##### 纠错编码
编码集的汉明距离 $d_s=2r+1$, 则该差错编码可以纠正 `r` 位的差错
例如：发送 2 位数据信息，冗余信息是数据的两次复制
编码集为 { 000000, 010101, 101010, 111111 }
编码集的汉明距离为 3
则 $r=\frac{d_s-1}{2}=1$
因此可以检测 1 位的差错

当数据在传输的时候发生了一位差错，则错码距离发生错误的有效码字的汉明距离最近，可以恢复有效码字。
例如：收到码字为 `100010`,则有效码字为
`100010` 与 { 000000, 010101, 101010, 111111 }的汉明距离为：{ 2, 5, 1, 4 }
与`100010` 汉明距离最短的是 `101010`，则有效码字即为：`101010`

#### 典型的差错编码
一些比较典型的差错编码方案

##### 奇偶校验码
最简单的检错码，利用冗余的一位码作用检验信息，实现差错检测
分类：奇检验码、偶检验码

在数据后面新增一位，取值 0 或 1，使得**编码后**的码字中 “1” 的个数为奇数或偶数（取决于使用奇检验码还是偶检验码）。
例如：`101011` 采用奇检验码的话，编码之后则为 `1010111`;
而`101010` 则为 `1010100`;
`101011` 采用偶检验码的话，编码之后则为 `1010110`;
`101010` 则为 `1010101`;

奇偶检验码的优点在于，编码简单，效率高且**开销最小**。缺点则在于**检错率不高**

##### 循环冗余码（Cyclic Redundancy Check, CRC 码）
在数据链路层广泛应用的差错编码（检错码）
基本思想：将二进制位串看成系数为 0 或者 1 的多项式系数
例如多项式 $G(x)=x^5+x^2+1$ 对应的二进制位串为 `100101`
其实就是位串的二进制数就是每个多项式的系数

| 多项式拆解 | $x^5$         | $x^4$          | $x^3$          | $x^2$          | $x^1$          | $x^0$          |
| ---------- | ------------- | -------------- | -------------- | -------------- | -------------- | -------------- |
| 位串       | 1             | 0              | 0              | 1              | 0              | 1              |
| 相乘       | $1\times x^5$ | $0 \times x^4$ | $0 \times x^3$ | $0 \times x^2$ | $0 \times x^1$ | $0 \times x^0$ |

所以二进制位串则为 `100101`，多项式为 $G(x)=1 \times x^5 + 0 \times x^4 + 0 \times x^3 + 1 \times x^2 + 0 \times x^1 + 1 \times x^0 = x^5+x^2+1$

###### 编码过程
1. 在帧的低位端加上r个0位，使该帧扩展为m+r位（相当于左移r位），对应的多项式为xrM(x)
2. 用G(x)系数对应的位串，去除（模2除法）xrM(x)系数对应的位串，求得r位余数R
3. 用xrM(x)系数对应的位串，减（模2减法）去余数R，结果就是完成CRC编码的帧

例：假设 CRC 编码生成的多项式为 $G(x)=x^4+x+1$，请为位串 `10111001` 进行 CRC 编码

第一步，写出多项式对应的位串
$G(x)=x^4+x+1$=`10011`
第二步，在待编码的位串后面添加 `r-1` 个 0，相当于 左移 `r-1` 位，`r` 为多项式位串的位数或者多项式最高项的系数，例子这里是 `5`
则处理后的待编码位串为 `101110010000`
第三步，将得到的新待编码位串与多项式二进制位串做异常运算，取其余数（即新待编码位串与多项式二进制位串做取模操作）
![](http://cdn.liwuhou.cn/tmp/20221003201346.png)
等到 `1001`
第四步，将取到的余数跟新待编码位串做加法运算，得到的就是 CRC 编码后的码
待编码位串：`101110010000`
余数：`1001`
CRC 编码后的码：`101110011001`
检验一遍，用`101110011001` 除以 `10011`，能整除，余数为 0。

###### 接收方判错
接收方接收到 带有 CRC 编码的帧之后，用收到的位串除以多项式对应的位串
如果余数为 0，则数据正确
如果余数不为 0，则有错

在 CRC 编码中，发送方和接收方双方都会约定好采用哪个生成多项式对码进行处理

## 多路访问控制协议
点对点通信：一对一通信方式，信息被双方独享（例如拨号上网）
广播通信（共享介质）：一对多通信方式，信道上连接的点很多，信道被结点共享（例如 wifi，总线以太网）

### 多路访问控制协议（Multiple Access Control， Mac）
用来解决广播信道两个或多个结点同时传输数据造成的冲突问题，也就是**解决信道的共享问题**

MAC 协议又分为：信道划分 MAC 协议、随机访问 MAC 协议、受控接入 MAC 协议

#### 信道划分 MAC 协议
利用多路复用技术实现信道共享的 MAC 协议
多路复用的基本思想：将信道资源划分，以分配给不同的结点，各节点通信时，只使用其分配到的资源，避免多结点通信时的相互干扰

##### 频分多路复用（Frequency-division multiplexing，FDM）
在频域内将信道带宽划分为多个子信道，将原始信号调制到对应子信道的载波信号上，使同时传输的多路信号在整个物理信道带宽的允许范围内**频谱不重叠**，从而共用一个信道。

##### 时分多路复用（Time-Division Multiplexing，TDM）
将通信信道的传输信号划分为多个等长的时隙，每路信号占用不同的**时隙**。使多路信号合用单一的通信信道在时域上不重叠，从而实现信道共享。

1. 按照固定顺序把时隙分配给各路信号。 
    - 同步时分多路复用(Synchronism Time-Division Multiplexing , STDM)
2. 时隙和用户间没有固定的对应关系。
    - 异步时分多路复用(Asynchronism Time-Division Multiplexing , ATDM)
    - 统计时分多路复用(Statistic Time-Division Multiplexing , STDM)

##### 波分多路复用（ Wave Division Multiplexing , WDM）
广泛用于光纤通信。在光纤通信中，光载波频率很高，通常用光的波长来代替频率讨论，所以叫做波分多路复用。
在光纤通信中，为了实现长距离的高速传输，**通常采用波分多路复用**和光纤放大器。

##### 码分多路复用（Code Division Multiplexing, CDM）
通过利用相互正交的码组分别编码各路原始信息的每个码元，使得编码后的信号在同一信道中混合传输。是一种扩频的通信形式。
> 相互正交：码组1：{1,0,1}
> 码组2：{0,1,0}
> 1×0+0×1+1×0=0

#### 随机访问 MAC 协议
随机访问MAC协议：所有用户都可以根据自己的意愿随机地向信道上发送信息。   
- 没有其他用户：发送成功。
- 有两个及以上用户：产生冲突或碰撞，用户发送信息失败。每个用户随机退让一段时间后，再次尝试，直至成功。

##### ALOHA 协议（只说不听）
最早的，最基本的无线数据通信协议。**只负责说，不负责听**
ALOHA协议分类：纯ALOHA和时隙ALOHA

- 纯ALOHA：
    - 工作原理：任何一个站点有数据发送时就可以直接发送至信道。
    - 发送数据后对信道进行侦听：
        - 如果收到应答信号，说明发送成功；
        - 否则说明发生冲突，等待一个随机时间重新发送，直到成功为止。
    - 性能：
    - ![](http://cdn.liwuhou.cn/tmp/20221003210350.png)
        - G网络负载：表示在一帧的发送时间内发送的平均帧数。
        - S吞吐量：在一帧的发送时间内成功发送的平均帧数。
        - 网络负载不能大于0.5

- 时隙ALOHA：
    - 工作原理：把信道时间划分为离散的时隙，每个时隙为发送一帧所需的时间，每个通信站点只能在每个时隙开始的时刻发送帧。如果在一个时隙内发送帧出现冲突，下一个时隙以概率p重发该帧，直到帧发送成功。p不能为1，否则会出现死锁。
    - ![](http://cdn.liwuhou.cn/tmp/20221003210517.png)



##### 载波监听多路访问协议（Carrier Sense Multiple Access , CSMA）（先听后说）

通过硬件装置（载波监听装置），在通信站发送数据之前，先监听信道上其他站点是否在发送数据，如果在发送，则暂时不发送。
分类：根据监听策略不同：
1. 非坚持CSMA（若信道上空闲则发送数据，否则就过一会再来询问）
2. 1-坚持CSMA（若信道上空闲则发送数据，否则一直监听，直到信息出现空闲为止）
3. P-坚持CSMA（若信道上空闲有 p 概率发送数据，而在 1-p 概率上，即使介质空闲，也会延迟一定时间发送数据）

##### 带冲突检测的载波监听多路访问协议（Carrier Sense Multiple Access/Collision Detection , CSMA/CD）（先听后说，边听边说）

通信站使用CSMA协议进行数据发送，在发送期间如果能检测到碰撞，立即终止发送，并发出一个冲突强化信号，使所有通信站点都知道冲突的发生。发出冲突强化信号后，等待一个随机时间，再重复上述过程。

CSMA/CD 有三个工作状态：传输周期、竞争周期、空闲周期，对应的信道上有三种状态：传输状态、竞争状态、空闲状态

使用CSMA/CD协议实现多路访问时，通过共享信道通信的两个通信站之间相距的最远距离D，信号的传播速度V，数据帧长度L，以及信道信息传输速率R之间满足以下约束：

$$\frac {L_{min}}{R} ≥ {\frac {2D_{max}}{V}}$$

信道的传输距离与信号的传播速度（$\frac {D_{max}}{V}$）其实就是信号的传播时延，这里最极端的情况就是冲突信号在信道上跑了个来回，所以是 2 倍速的距离，也就是 2 倍的传输时延。

![](http://cdn.liwuhou.cn/tmp/20221004115117.png)

例：在一个采用CSMA/CD协议的网络中，传输介质是一根完整的电缆，数据传输速率为1Gbit/s，电缆中的信号传播速度是200000km/s。若最小数据帧长度为800bit，则最远的两个站点之间的距离为多少？

**分析可知，这里需要求的是 D 的值，根据公式，将对应的值代进去就行了，还要注意单位的换算**
$$D_{max} = \frac {L_{min} \times {V}}{2R} = \frac {800(bit) \times 2 \times 10^8(m/s)}{2 \times {1 \times 10^9(bps)}} = 80(m)$$

即最远两个站点之间的距离为 80 米

##### 受控 MAC 协议

各个用户不能随意的接入信道而必须服从一定的控制。
这类控制又分为两类：
 1. 集中式控制
 2. 分散式控制

###### 集中式控制
系统有一个主机负责调度其他通信站接入信道，从而避免冲突。
方法：轮询。（1、轮叫轮询；2、传递轮询）

![](http://cdn.liwuhou.cn/tmp/20221004121029.png)

###### 分散式控制
即令牌技术
令牌是一种特殊的帧，代表了通信站使用信道的许可。在信道空闲时一直在信道上传输。一个通信站想要发送数据就必须首先获得令牌。

![](http://cdn.liwuhou.cn/tmp/20221004121127.png)

**令牌环的操作过程：**
1. 网络空闲时，只有一个令牌在环路上绕行。
2. 当一个站点要发送数据时，必须等待并获得一个令牌，将令牌的标志位置为“1”，随后便可发送数据。（空令牌：标志位置为“0”。被占用：标志位置为“1” ）
3. 环路中的每个站点边转发数据，边检查数据帧中的目的地址，若为本站点的地址，便读取其中所携带的数据。
4. 数据帧绕环一周返回时，发送站将其从环路上撤销，即“自生自灭”。
5. 发送站点完成数据发送后，重新产生一个令牌传至下一个站点，以使其他站点获得发送数据帧的许可权。

**环网上最严重的两种错误**
**令牌丢失**和**数据帧无法撤销**是环网上最严重的两种错误。 

## 局域网
采取广播的方式，局部区域网络，覆盖面积小，网络传输速率高，传输的误码率低。 

为了使数据链路层更好地适应多种局域网标准，IEEE802委员会将局域网的数据链路层拆分为两个子层：
- 逻辑链路控制(Logical Link Control ,LLC)子层（名存实亡）
- 介质访问控制(medium access control，MAC)MAC子层 

### MAC 地址
MAC地址具有唯一性，**每个网络适配器**对应一个MAC地址。 
MAC地址空间的分配：由电气和电子工程师协会(IEEE)统一管理。IEEE分配前24位的MAC地址块。

以太网和IEEE 802.11无线局域网，使用的MAC地址长度为6字节（48位）。
通常采用十六进制表示法，每个字节表示一个十六进制数，用 - 或：连接起来：
例如：00-2A-E1-76-8C-39 或 00:2A:E1:76:8C:39
MAC 的广播地址为 FF:FF:FF:FF:FF:FF


### 地址解析协议（Address Resolution Protocol, ARP）
根据本网内目的主机或默认网关的 IP 地址获取其 MAC 地址
地址解析协议的基本思想：在每一台主机中设置专用内存区域，称为ARP高速缓存(也称ARP表)。存储该主机所在局域网中其他主机和路由器的IP地址与MAC地址的映射关系。

ARP查询分组：通过一个广播帧发送的
ARP响应分组：通过一个单播帧发送的
ARP是即插即用的：一个ARP表是自动建立的，不需要系统管理员来配置。

| IP地址       | MAC地址           | TTL      |
| ------------ | ----------------- | -------- |
| 178.169.1.96 | 00-53-2B-49-1A-1F | 13:45:00 |
| 178.169.1.94 | 00-BD-2A-90-17-C2 | 13:52:00 |

### 以太网
ethernet, IEEE802.3
目前为止最流行的有线局域网技术

#### 以太网成功的原因（物美价廉）

1. 以太网是**第一个广泛部署的高速局域网**
2. 以太网的数据速率快
3. 以太网的硬件价格便宜，网络造价成本低
4. 其它有线网络技术复杂、昂贵，阻止了网络管理员改用其它技术

#### 经典型以太网
经典的以太网是采用粗同轴电缆连接的总线型以太网（10Base-5）
1、数据传输速率为10Mbit/s，无连接不可靠。 
2、MAC协议采用CSMA/CD协议。 
3、相距最远主机信号往返的传播时延为51.2μs,所以**以太网最短帧长为64字节**。

> 了解即可：10代表传输速度为10Mbps，BASE指的是传输信号为基带信号，5指的是单段大致的传输距离、使用单段最大传输距离为500米电阻为50Ω的粗缆，最多可以通过中继器/集线器连接5个网段，10BASE5的单段最大传输距离不会超过500米，最长距离可达2500米。

#### 以太网帧结构

![](http://cdn.liwuhou.cn/tmp/20221004160623.png)

- 目的地址和源地址都是 MAC 地址，都为 6 个字节。
- 类型用以标识上层协议
- 数据是封装的上层协议的分组
- CRC 位用来放置检验用的循环冗余码

#### 以太网最短帧（重要）
**以太网的最短帧为 64 字节，除数据部分其余占 18 个字节，数据最短是 46 个字节**，

#### 以太网技术

| 分类                    | 传输介质                      | 传输速率   | 标准                 |
| ----------------------- | ----------------------------- | ---------- | -------------------- |
| 10Base-5（经典以太网）  | 粗同轴电缆                    | 10Mbit/s   |                      |
| 10Base-T                | 非屏蔽双绞线(UTP)             | 10Mbit/s   | IEEE 802.3           |
| 100Base-T（快速以太网） | UTP                           | 100Mbit/s  | IEEE 802.3u          |
| 千兆位以太网            | 光纤、UTP、屏蔽双绞线（STP） | 1000Mbit/s | IEEE 802.3标准的扩展 |
| 万兆位以太网            |                               | 10Gbit/s   | IEEE 802.3ae         |

### 交换机

交换机是应用最广泛的数据链路层设备

网桥：和交换机功能类似，可以对数据帧实现转发，交换机可以认为是多端口的网桥

集线器：物理层

#### 以太网交换机转发和过滤
交换机的基本工作原理，当一帧到达时，交换机首先需要决策将该帧丢弃还是转发。
如果是转发的话，还必须进一步决策应该将该帧转发到哪个（或哪些）端口去。决策依据是，以目的MAC为主键查询内部转发表。

#### 以太网交换机的自学习
会利用 ARP 协议，记录对应端口的 MAC 地址，保存在转发表中。

#### 以太网交换机的优点

1. 消除**冲突**
    - 早期所有主机共享总线的一个网络范围。现在在以太网中，CSMA/CD能够检测到冲突的网络范围。
2. 支持**异质**电路
3. 网络**管理**

### 虚拟局域网
(Virtual Local Area Network , VLAN)
一种基于交换机的逻辑分割广播域的局域网应用形式。
以软件的方式划分和管理局域网中的工作组，限制接收广播信息的主机数，不会因为传播过多的广播信息而引起性能的恶化。
避免局域网风暴与蠕虫病毒

#### 划分虚拟局域网方法
1. 基于**交换机端口**划分
2. 基于**MAC 地址**划分
3. 基于**上层协议或地址**划分

## 点对点链路协议
（Point to Point Protocol, PPP）：适合单个发送方和单个接收方的点对点链路

### PPP 主要提供 3 类功能
1. 成帧：确定一帧的开始和结束，支持差错检测
  1. 开始标志字节：01111110
  2. 结束标志字节：01111110
  3. ![](http://cdn.liwuhou.cn/tmp/20221005150149.png)
2. 链路控制协议（Link Control Protocol, LCP）
  1. 启动线路、检测线路、协商参数、关闭线路
3. 网络控制协议（Network Control Protocol，NCP）
  1. 协商网络层选项

### PPP 是面向字节的
1. PPP 帧的长度都是整数字节
2. 插入一个 `01111110` 的标志字段
3. 字节填充技术：如果有数据是标志字段`01111110`的话，就插入特殊的控制转义字节 `01111101`，相当于编辑语言中的 `\`

### 高级数据链路控制协议
（High-level Data Link Control，HDLC）：应用于点对点链路和点对多点链路

HDLC 帧格式点 6 个字节
![](http://cdn.liwuhou.cn/tmp/20221005151049.png)

1. `01111110`：帧定界符
2. 控制字段：序列号、确认等
3. 检验和：循环冗余码
4. 根据控制位的不同，HDLC 有 3 种类型的帧：
  1. 信息帧（I 格式 Information）：传送数据
  2. 管理帧（S 格式 Supervisory）：差错控制，流量控制
  3. 无序号帧（U 格式 Unnumbered）：链路的建立、拆除
4. HDLC 协议是面向位的，填充也是对于位的填充

当数据字段出现与标志字段相同的比特流时，比如：`100*01111110*010010`
发送端会在发送的时候，检测到有**5 个连续的 1，就在其后插入一个 0**断开，所以上述字段会变成 `100*011111010*01001`
而接收端在接收的时候发现有 5 个连续的 1 就会删除其后的 0 恢复数据，所以接收端接收到的数据是正常的`100*01111110*010010`

PPP 是字节填充，而 HDLC 是位填充。二者都是面向连接的协议，且二者开始和结束的标志字节都是`01111110`，不同之处在于处理转义的方式，由于 PPP 是字节填充的，所以会在歧义的字节前插入`01111101`，而 HDLC 会发现连续 5 个 1 的时候，在后面插个 0


# 物理层

## 数据通信基础

### 数据通信基本概念
消息与信息的区别
消息：人类能够感知的描述
  例如：眼睛看到的文字和图像；耳朵听到声音；鼻子闻到气味等
信息：消息中所包含的有意义的内容

> 通信是在**一点**精确或近似地再生**另一点**的信息 —— 香农

**通信系统**：能够实现通信功能的各种技术、设备和方法的总体

**信号**：在通信系统中，信息在传输通道中传播的载体

**信道**
狭义信道：仅是指信号的传输介质
广义信道：不仅是传输介质，而且包括通信系统中的一些转化装置

### 数据通信系统模型

一次数据通信的构成由：
- 信源：将消息转换为信号的设备
- 发送设备：将信源产生的信号进行适当变换的装置
- 信道：传输信号的媒介
- 接收设备：完成发送设备的反变换，即进行译码和解调
- 信宿：信号的终点，将信号转换为供人们识别的消息
- 噪声源：自然界的通信设备所固有的，对通信信号产生干扰和影响的各种信号


#### 模拟通信和数字通信

1. 模拟信号
  - 自变量：可以连续，可以离散
  - 因变量：一定连续的
  - ![](http://cdn.liwuhou.cn/tmp/20221005153948.png)
2. 数字通信
  - 自变量：离散的
  - 因变量：离散的
  - ![](http://cdn.liwuhou.cn/tmp/20221005154256.png)

### 数据通信方式

1. 数据传输方向：单向通信、双向交替通信（半双工）和双向同时通信（全双工）
2. 数据传输时空顺序：并行通信和串行通信
3. 数据同步技术：通信系统中实现收发两端动作统一，保持收发步调一致的过程
  1. 异步通信：发送字符，不需建立同步时钟，实现简单，适用低速网络
  2. 同步通信：发送数据块，双方建立同步时钟，实现复杂，适用高速网络

## 物理介质

### 导引型传输介质
其实就是有线信道

**架空明线**
优点：传输损耗较低
缺点：易受天气和外界电磁干扰、对外界噪声敏感、带宽有限

**双绞线**：两根相互绝缘 的铜线并排绞合在一起
![](http://cdn.liwuhou.cn/tmp/20221005155534.png)

分类：
1. 屏蔽双绞线（STP）：性能好，价格高，安装工艺复杂
2. 非屏蔽双绞线（UTP）：使用更普遍，价格便宜

美国电子工业协会（EIA）规定了 5 个各类的非屏蔽双绞线（UTP）标准

| UTP类别     | 带宽MHz | 典型应用                                  |
| ----------- | ------- | ----------------------------------------- |
| 3           | 16      | 低速网络，电话网络                        |
| 4           | 20      | 10Base-T以太网                            |
| 5           | 100     | 10Base-T以太网，100Base-T快速以太网       |
| 5E（超5类） | 100     | 100Base-T快速以太网，1000Base-T千兆以太网 | 
| 6           | 250     | 1000Base-T千兆以太网                      |

**同轴电缆**：由同轴的两个导体构成，外导体和内导体

![](http://cdn.liwuhou.cn/tmp/20221005160013.png)

对外界干扰具有较好的屏蔽作用，具有较好的抗电磁干扰性能。目前多用于有线电视网络。

**光纤**：基本原理是利用了光的全反射现象

![](http://cdn.liwuhou.cn/tmp/20221005160123.png)

按照光纤内光波传输模式的不同可分为：单模光纤和多模光纤

优点：
1. 光纤通信容量非常大，最高可达 100Gbit/s
2. 传输损耗小，对远距离传输特别经济
3. 抗雷电和电磁干扰性能好
4. 无串音干扰，保密性好，也不易被窃听或截取数据
5. 体积小，重量轻

### 非导引型传输介质
即是无线通信，利用了电磁波可以在自由空间的传播

根据电磁波频率、通信距离与位置的不同，电磁波的传播可以分为：

| 电磁波传播方式 | 频率       | 距离地表高度      | 例子       |
| -------------- | ---------- | ----------------- | ---------- |
| 地波传播       | 2MHz 以下  | 沿地表            | 广播、声呐 |
| 天波传播       | 2-30 MHz   | 距离地表 60-400km | 电话、传真 |
| 视线传播       | 高于 30MHz | 电离层之上        | 电视、GPS  |

## 信道与信道容量

通信系统中**连接**发送端与接收端的通信设备，实现从发送端到接收端的信号传送

分为广义信道和狭义信道
  狭义信道：信号传输介质
  广义信道：包括信号传输介质和通信系统的一些变换装置

### 广义信道的组成

![](http://cdn.liwuhou.cn/tmp/20221005161252.png)

编码信道：数字信号由编码器输出端传输到译码器输入端经过的部分
调制信道：从调制器的输出端传输到解调器的输入端经过的部分

### 信道传输特性

不同类型的信道对信号的影响差异较大：
随机参数信道（随参信道）：信号通过信道发生畸变是**时变的**
恒定参数信道（恒参信道）：信号通过信道发生畸变是**恒定的**

#### 随参信道传输特性
大部分无线信道（依靠地波和天波传播的无线电信道）
1. 信号的传输衰减随时间**随机**变化
2. 信号的传输时延随时间**随机**变化
3. 存在**多径**传播现象

#### 恒参信道传输特性
各种有线信道和部分无线信道（微波视线传播链路）

1. 对信号幅值产生**固定的**衰减
2. 对信号输出产生**固定的**时延

### 信道容量
信道无差错传输信息的**最大平均信息速率**。是衡量信道的传输能力。
1. 信道的带宽是指能够有效通过该信道的信号的**最大频带宽度**
  用码元速率（或符号速率）描述，单位是 Baud
2. 传输速率是信道**单位时间**内传输的码元（或符号）或信息的能力
  用传信率（或信息速率）来描述，单位是 bit/s

#### 连续信道容量（调制信道）
奈奎斯特理想的，**无噪声**的信道容量（也称最大数据传输速率）

$$ C=2Blog_2M$$

> 1. C：信道容量，单位是 bit/s
> 2. B：信道带宽，单位是 Hz
> 3. M 进制数，即信号状态数

香农有噪声连续信道容量公式

$$ C=Blog2(1+ \frac {S}{N})$$

> 1. C信道容量，单位是 bit/s
> 2. B：带宽，单位是 Hz
> 3. S：输入信号功率
> 4. N：高斯白噪声的功率
> 5. $\frac {S}{N}$：信噪比

其中需要注意的是，香农有噪声连续信道容量公式中的信噪比的单位是功率，而出题给出的单位经常是 db，这里就需要 db 与功率单位之间的换算公式

分贝和功率的换算公式：

$$ (\frac {S}{N})dB = 10lg(\frac {S}{N})w $$

换算可得功率单位的信噪比为：

 $$ (\frac {S}{N})w = 10^{\frac {(\frac {S}{N})db}{10}} $$

## 基带传输

基带信号是信源发出的没有经过调制的原始信号
基带传输是指直接将没有经过调制的基带信号在信道上传输
数字基带传输是在信道上传输数字基带信号

### 数字基带传输编码之信号码

将数据映射为脉冲信号的信号码

信号码中的单双极与归零不归零的一些区别：

单极和双极：脉冲幅值要么是正电平，要么是负电平的，只有一个极性的就是单极。反之就是双极。
归零和不归零：在每个脉冲持续期间的中间时刻，电平都要回归零电平的，就是归零；反之在脉冲持续时间内，电平保持不变，且在脉冲持续时间结束后不回归零电平的为不归零 

#### 单极不归零码
就像他的名字，单极且不归零，只有正极，并且不会在脉冲的中间时刻回归零电平
数字0：用零电平表示
数字1：用正电平表示

![1100100111](http://cdn.liwuhou.cn/tmp/20221010082047.png)

#### 双极不归零码
数字0：负电平
数字1：正电平

![](http://cdn.liwuhou.cn/tmp/20221010082330.png)

#### 单极归零码（Return to Zero, RZ）
数字0：零电平表示
数字1：正电平表示，且在脉冲持续时间的中间时刻回归到零电平

![](http://cdn.liwuhou.cn/tmp/20221010082451.png)

#### 双极归零码
数字0：负电平表示，且在脉冲持续时间的中间时刻回归到零电平
数字1：正电平表示，且在脉冲持续时间的中间时刻回归到零电平

![](http://cdn.liwuhou.cn/tmp/20221010082757.png)

#### 差分码（重要）
利用电平的跳变与否来表示信息
将当前脉冲时间的电平与前一个脉冲时间的电平做比较
数字0：相邻间的电平没有跳变
数字1：相邻间的电平发生跳变
注：默认初始是零电平

![](http://cdn.liwuhou.cn/tmp/20221010083105.png)

### 数字基带传输编码之传输码
将数字基带信号的基本码型变换为适合传输的数字传输基带传输码
共有：AMI码、 双相码、米勒码、CMI码

##### AMI码
又称信号交替反转码
用三种电平信号进行编码
数字0：用零电平来表示
数字1：交替使用正负电平来表示，且在脉冲持续时间回归零电平

![](http://cdn.liwuhou.cn/tmp/20221010084048.png)

